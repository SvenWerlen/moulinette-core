(()=>{"use strict";class e extends FormApplication{static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinetteHome",classes:["mtte","home"],title:game.i18n.localize("mtte.moulinetteHome"),template:"modules/moulinette-core/templates/home.hbs",width:"400",height:"350",closeOnSubmit:!1,submitOnClose:!1})}getData(){return game.user.isGM?{modules:game.moulinette.modules.sort(((e,t)=>e.name<t.name?-1:1))}:{error:game.i18n.localize("mtte.errorGMOnly")}}activateListeners(e){super.activateListeners(e),this.bringToTop(),e.find("img.button").click(this._onSelect.bind(this))}async _onSelect(e){e.preventDefault();const t=e.currentTarget;for(const e of game.moulinette.modules)t.classList.contains(e.id)&&(new e.class).render(!0)}}class t extends FormApplication{static CLIENT_ID="K3ofcL8XyaObRrO_5VPuzXEPnOVCIW3fbLIt6Vygt_YIM6IKxA404ZQ0pZbZ0VkB";static DISCORD_CLIENT_ID="1104472072853405706";constructor(e){super(),this.callingWindow=e,this.forceRefresh=!1}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinette-patreon",classes:["mtte","patreon"],title:game.i18n.localize("mtte.moulinettePatreon"),template:"modules/moulinette-core/templates/patreon.hbs",width:650,height:"auto",resizable:!0,closeOnSubmit:!1,submitOnClose:!1})}async getData(){if(!game.settings.get("moulinette-core","enableMoulinetteCloud"))return{disabled:!0};return{user:await game.moulinette.applications.Moulinette.getUser(!0,this.forceRefresh)}}activateListeners(e){super.activateListeners(e),this.html=e;const t=this;e.find("button").click(this._onClickButton.bind(this)),this.callingWindow&&(this.callingWindow.noBringToTop=!0,this.callingWindow.render(!0)),e.find(".mouCloudEnable").click((async function(e){e.preventDefault(),await game.settings.set("moulinette-core","enableMoulinetteCloud",!0),t.render()})),this.bringToTop()}async _onClickButton(e){e.preventDefault();const i=e.currentTarget;if(i.classList.contains("continue"))console.log("Moulinette Patreon | Refreshing"),game.moulinette.cache.clear(),this.render();else if(i.classList.contains("refresh"))this.forceRefresh=!0,this.html.find(".login button").hide(),this.render();else if(i.classList.contains("loginPatreon")){const e=randomID(26),s=`${game.moulinette.applications.MoulinetteClient.SERVER_URL}/patreon/callback`,i=`https://www.patreon.com/oauth2/authorize?response_type=code&client_id=${t.CLIENT_ID}&redirect_uri=${s}&scope=identity identity.memberships&state=${e}`;game.moulinette.cache.clear(),await game.settings.set("moulinette","userId",e),window.open(i,"_blank"),this.html.find(".login").hide(),this.html.find(".error").show(),this.html.find(".error").html(game.i18n.localize("mtte.continue"));const a=this;this.timerIter=0,this.timer=setInterval((async function(){const t=a.html.find(".progress");if(a.timerIter>60)return a.html.find(".error").html(game.i18n.localize("mtte.authenticationTimeout")),t.html(""),clearInterval(a.timer);a.timerIter++,t.html(t.text()+" .");const s=new game.moulinette.applications.MoulinetteClient,i=((new Date).getTime(),await s.get(`/user/${e}/ready?patreon=1`));i&&200==i.status&&"yes"==i.data.status&&(clearInterval(a.timer),a.render())}),2e3)}else if(i.classList.contains("loginDiscord")){const e=26==game.moulinette.user.id.length?game.moulinette.user.id:randomID(26),s=`${game.moulinette.applications.MoulinetteClient.SERVER_URL}/discord/callback`,i=`https://discord.com/oauth2/authorize?response_type=code&client_id=${t.DISCORD_CLIENT_ID}&scope=identify guilds guilds.members.read&redirect_uri=${s}&state=${e}`;game.moulinette.cache.clear(),await game.settings.set("moulinette","userId",e),window.open(i,"_blank"),this.html.find(".login").hide(),this.html.find(".error").show(),this.html.find(".error").html(game.i18n.localize("mtte.continue"));const a=this;this.timerIter=0,this.timer=setInterval((async function(){const t=a.html.find(".progress");if(a.timerIter>60)return a.html.find(".error").html(game.i18n.localize("mtte.authenticationTimeout")),t.html(""),clearInterval(a.timer);a.timerIter++,t.html(t.text()+" .");const s=new game.moulinette.applications.MoulinetteClient,i=((new Date).getTime(),await s.get(`/user/${e}/ready?discord=1`));i&&200==i.status&&"yes"==i.data.status&&(clearInterval(a.timer),a.render())}),2e3)}else i.classList.contains("logout")?(console.log("Moulinette Patreon | Loging out"),await game.settings.set("moulinette","userId","anonymous"),game.moulinette.cache.clear(),this.render()):i.classList.contains("gift")&&new s(this).render(!0)}static hasEarlyAccess(){return["Dwarf blacksmith","Dwarf goldsmith","Dwarf goldsmith II","Dwarf goldsmith III","Dwarf noble","Owner"].includes(game.moulinette.user.patron)}close(){this.timer&&clearInterval(this.timer),super.close()}}class s extends FormApplication{constructor(e){super(),this.parent=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinette-gift",classes:["mtte","gift"],title:game.i18n.localize("mtte.moulinettePatreonGift"),template:"modules/moulinette-core/templates/patreon-gift.hbs",width:400,height:"auto",closeOnSubmit:!1,submitOnClose:!1})}async _updateObject(e){const t=this.html.find("#coupon").val(),s=new game.moulinette.applications.MoulinetteClient,i=await s.get(`/creators/gifts/claim/${game.moulinette.user.id}/${t}`);i&&200==i.status?(this.parent.render(),this.close()):(ui.notifications.error(game.i18n.localize("mtte.errorInvalidGift")),console.error(`Moulinette Patreon | Invalid gift '${t}'`))}activateListeners(e){this.html=e,super.activateListeners(e)}}class i{constructor(e,t,s){Hooks.on(e,this.handle.bind(this)),this.type=t}static showMoulinette(){(new e).render(!0)}static prettyText(e){try{e=decodeURIComponent(e)}catch(e){}const t=(e=(e=(e=e.replace(/[_-]/g," ")).replace(/([^ ])\(/g,"$1 (")).replace(/\)([^ ])/g,") $1")).lastIndexOf(".");return t>0&&e.length-t<=5&&(e=e.substr(0,t)),e=(e=e.replace(/(\d+)$/g," $1")).replace(/ +(?= )/g,"")}static prettyNumber(e){return e.toLocaleString()}static prettyBreadcrumb(e){const t=e.split("##");if(3!=t.length)return e;return(t[0].length>0?`<div class="bc creator"><i class="fas fa-palette"></i> ${t[0]}</div>`:"")+(t[1].length>0?`<div class="bc pack"><i class="fas fa-box"></i> ${t[1]}</div>`:"")+(t[2].length>0?`<div class="bc path"><i class="fas fa-folder"></i> ${t[2]}</div>`:"")}static async getUser(e=!1,s=!1){const i=game.settings.get("moulinette","userId");if(!game.settings.get("moulinette-core","enableMoulinetteCloud"))return console.log("Moulinette | Moulinette Cloud is disabled."),game.moulinette.user={id:game.settings.get("moulinette","userId"),hasEarlyAccess:function(){return!1}},game.moulinette.user;if(game.user.isGM&&(!game.moulinette.user.cache||e)){console.log("Moulinette | Retrieving user details");const e=new game.moulinette.applications.MoulinetteClient,a="?ms="+(new Date).getTime(),o=s?"force=1":"",n=await e.get(`/user/${i}${a}&${o}`);n&&200==n.status&&(game.moulinette.user=n.data,game.moulinette.user.hasEarlyAccess=t.hasEarlyAccess,n.data.guid&&(await game.settings.set("moulinette","userId",n.data.guid),delete n.data.guid)),game.moulinette.user.cache=!0}return game.moulinette.user.id=game.settings.get("moulinette","userId"),game.moulinette.user}static async fillMoulinetteCache(){await game.moulinette.applications.Moulinette.getUser();return await game.moulinette.applications.MoulinetteFileUtil.buildAssetIndex([game.moulinette.applications.MoulinetteClient.SERVER_URL+"/assets/"+game.moulinette.user.id])}static async updateS3URLs(){if(await game.moulinette.applications.Moulinette.fillMoulinetteCache(),!game.moulinette.user.id||"anonymous"==game.moulinette.user.id)return ui.notifications.warn(game.i18n.localize("mtte.errorLinkYourPatreon"));const e=/https:\/\/[a-zA-Z0-9\.]+.*digitaloceanspaces\.com\//,t=Array.from(game.scenes.values()).filter((t=>t.data.img&&t.data.img.match(e))),s=t.map((e=>e.data.img));let i={method:"POST",body:JSON.stringify(s),headers:{"Content-Type":"application/json"}};const a=await fetch(`${game.moulinette.applications.MoulinetteClient.SERVER_URL}/asset/s3/${game.moulinette.user.id}/BeneosBattlemaps`,i).catch((function(e){console.log(`MoulinetteClient | Cannot establish connection to server ${game.moulinette.applications.MoulinetteClient.SERVER_URL}`,e)})),o=await a.json();if(o&&o.length==t.length)for(let e=0;e<t.length;e++)await t[e].update({id:t[e]._id,img:o[e]}),console.log(`Moulinette | Background scene for ${t[e].name} has been successfully updated!`);else console.error("Moulinette | Something wrong on the Moulinette server. Try again or get support on Discord.")}static inprogress(e){e&&(e.prop("disabled",!0),e.addClass("inprogress"),e.append('<img class="mttespinner" src="modules/moulinette-core/img/spinner.gif"/>'))}static optimizePacks(e){const t={};for(const s of e){let e=s.name.trim();(e.endsWith("HD")||e.endsWith("4K"))&&(e=e.slice(0,-2).trim()),e=e.replace(/\([^\)]+\)/g,"").trim(),e in t?t[e].push(s):t[e]=[s]}return t}static cleanForSearch(e){return e.replace(/[-_]/g," ").toLowerCase()}static async getOrCreateFolder(e,t,s){let i=game.folders.filter((e=>"Moulinette"==e.name&&e.type==s));i=0==i.length?await Folder.create({name:"Moulinette",type:s}):i[0];let a=i.children?i.children.filter((t=>t.folder.name==e)):[];a=0==a.length?game.version.startsWith("12.")?await Folder.create({name:e,type:s,folder:i}):await Folder.create({name:e,type:s,parent:i.id}):a[0].folder;let o=a.children?a.children.filter((e=>e.folder.name==t)):[];return o=0==o.length?game.version.startsWith("12.")?await Folder.create({name:t,type:s,folder:a}):await Folder.create({name:t,type:s,parent:a.id}):o[0].folder,o}static async generateArticle(e,t,s){const i={name:e,pages:[],folder:s},a=t.split(".").pop();return["mp4","webm"].includes(a)?i.pages.push({name:e,type:"video",title:{show:!1,level:1},video:{controls:!1,volume:1,loop:!0,autoplay:!0,timestamp:0,width:null,height:null},src:t}):i.pages.push({name:e,type:"image",title:{show:!1,level:1},src:t}),await JournalEntry.create(i)}}class a extends PlaceablesLayer{static documentName="Scene";constructor(...e){super(...e),this.isSetup=!1}static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{zIndex:180,name:"moulinette"})}getDocuments(){return[]}activate(){super.activate()}deactivate(){super.deactivate(),this._clearChildren()}render(...e){super.render(...e)}_clearChildren(){this.UIContainer&&this.UIContainer.children.forEach((e=>{e.clear()}))}_onClickLeft(e){const t=this.worldTransform,s=(e.data.originalEvent.clientX-t.tx)/canvas.stage.scale.x,i=(e.data.originalEvent.clientY-t.ty)/canvas.stage.scale.y;let a=[s,i];a=canvas.grid.getCenter(s,i),canvas.dimensions.rect.contains(a[0],a[1])&&game.moulinette.forge.forEach((t=>t.instance.onLeftClickGrid({x:a[0],y:a[1],ctrl:e.data.originalEvent.ctrlKey,alt:e.data.originalEvent.altKey,shift:e.data.originalEvent.shiftKey})))}_onClickRight(e){const t=this.worldTransform,s=(e.data.originalEvent.clientX-t.tx)/canvas.stage.scale.x,i=(e.data.originalEvent.clientY-t.ty)/canvas.stage.scale.y;let a=[s,i];a=canvas.grid.getCenter(s,i),canvas.dimensions.rect.contains(a[0],a[1])&&game.moulinette.forge.forEach((t=>t.instance.onRightClickGrid({x:a[0],y:a[1],ctrl:e.data.originalEvent.ctrlKey,alt:e.data.originalEvent.altKey,shift:e.data.originalEvent.shiftKey})))}selectObjects(){}}class o{constructor(e){this.cache={}}clear(){this.cache={}}hasData(e){return e in this.cache}setData(e,t){console.log(`MoulinetteCache | Adding ${e} to cache`),this.cache[e]=t}getData(e){return console.log(`MoulinetteCache | Retrieving ${e} from cache`),e in this.cache?duplicate(this.cache[e]):null}}class n{static REMOTE_BASE="https://mttecloudstorage.blob.core.windows.net";static REMOTE_BASE_S3="https://nyc3.digitaloceanspaces.com";static LOCAL_SOURCES=["data","public"];static RETRIES=3;static MAX_THUMB_FILESIZE=10485760;static _s3BaseURL;static getSource(){var e="data";"undefined"!=typeof ForgeVTT&&ForgeVTT.usingTheForge&&(e="forgevtt");const t=game.settings.get("moulinette-core","s3Bucket");return t&&t.length>0&&"null"!=t&&(e="s3"),e}static getOptions(){let e={};const t=game.settings.get("moulinette-core","s3Bucket");return t&&t.length>0&&"null"!=t&&(e.bucket=t),e}static async getBaseURL(e=null){const t=game.settings.get("moulinette-core","s3Bucket");if((!e||"s3"==e)&&t&&t.length>0&&"null"!=t){if(n._s3BaseURL)return n._s3BaseURL;let e=await FilePicker.browse(n.getSource(),"",n.getOptions()),t="";if(0==e.files.length&&(await FilePicker.upload("s3","",new File(["Do NOT delete. Required by Moulinette"],"mtte.txt"),n.getOptions()),e=await FilePicker.browse(n.getSource(),"",n.getOptions())),e.files.length>0){const s=e.files[0];t=s.substr(0,s.lastIndexOf("/")+1)}return n._s3BaseURL=t,t}if("undefined"!=typeof ForgeVTT&&ForgeVTT.usingTheForge){if(!e||"forgevtt"==e){const e=ForgeVTT.ASSETS_LIBRARY_URL_PREFIX+(await ForgeAPI.getUserId()||"user");return e?e+"/":""}if("forge-bazaar"==e)return ForgeVTT.ASSETS_LIBRARY_URL_PREFIX+"bazaar/assets/"}return""}static generatePathFromName(e){return e.replace(/[^\w\s]/gi,"").replace(/ /g,"-").toLowerCase()}static async createFolderIfMissing(e,t){if("s3"==n.getSource())return;if(!(await FilePicker.browse(n.getSource(),e,n.getOptions())).dirs.includes(t))try{await FilePicker.createDirectory(n.getSource(),t,n.getOptions())}catch(e){console.warn(`MoulinetteFileUtil was not able to create ${t}`,e)}}static async createFolderRecursive(e){const t=n.getSource();if("s3"==t)return;const s=e.split("/");let i="";for(const e of s){if(0==e.length)continue;const s=await FilePicker.browse(t,i,n.getOptions());i+=(i.length>0?"/":"")+e;if(!s.dirs.map((e=>decodeURIComponent(e))).includes(decodeURIComponent(i)))try{console.log(`MoulinetteFileUtil | Create folder ${i}`),await FilePicker.createDirectory(t,i,n.getOptions())}catch(e){console.warn(`MoulinetteFileUtil was not able to create ${i}`,e)}}}static encodeURL(e){return e.split("/").map((e=>encodeURIComponent(e))).join("/")}static async fileExists(e,t){const s=t||n.getSource();try{const t=await n.getBaseURL(s);let i=t&&t.length>0&&e.startsWith(t)?e.substring(t.length):e;i=i.substring(0,i.lastIndexOf("/"));let a=null;n.lastFolder==i?a=n.lastFolderData:(a=await FilePicker.browse(s,i,n.getOptions()),n.lastFolder=i,n.lastFolderData=a);const o=a.files.map((e=>decodeURIComponent(e)));if("undefined"!=typeof ForgeVTT&&ForgeVTT.usingTheForge){const t=ForgeVTT.ASSETS_LIBRARY_URL_PREFIX+(await ForgeAPI.getUserId()||"user");e=(t?t+"/":"")+e}else"s3"==s&&(e=t+e);return a.files.includes(e)||o.includes(e)}catch(e){return console.log(e),!1}}static async upload(e,t,s,i,a=!1){const o=n.getSource();n.createFolderIfMissing(s,i);const l=await n.getBaseURL();let r=await FilePicker.browse(o,i,n.getOptions());const c=`${i}/${t}`;if(r.files.filter((e=>decodeURIComponent(e)==c)).length>0&&!a)return{path:`${l}${i}/${t}`};try{return"undefined"!=typeof ForgeVTT&&ForgeVTT.usingTheForge?(console.log("MoulinetteFileUtil | Uploading with The Forge"),await ForgeVTT_FilePicker.upload(o,i,e,n.getOptions(),{notify:!1})):await FilePicker.upload(o,i,e,n.getOptions(),{notify:!1})}catch(e){console.log(`MoulinetteFileUtil | Not able to upload file ${t}`),console.log(e)}}static async uploadFile(e,t,s,i=!1,a){const o=a||n.getSource();await n.createFolderRecursive(s);const l=await n.getBaseURL();if((await FilePicker.browse(o,s,n.getOptions())).files.filter((e=>decodeURIComponent(e)==`${s}/${t}`)).length>0&&!i)return{path:`${l}${s}/${t}`};try{return"undefined"!=typeof ForgeVTT&&ForgeVTT.usingTheForge?(console.log("MoulinetteFileUtil | Uploading with The Forge"),await ForgeVTT_FilePicker.upload(o,s,e,n.getOptions(),{notify:!1})):await FilePicker.upload(o,s,e,n.getOptions(),{notify:!1})}catch(e){console.log(`MoulinetteFileUtil | Not able to upload file ${t}`),console.log(e)}}static async scanAssets(e,t,s){const i=game.settings.get("moulinette-core","debugScanAssets");s||(s=n.getSource());let a=[];i&&console.log(`Moulinette FileUtil | Root: scanning ${e} ...`);let o=await FilePicker.browse(s,e,n.getOptions());if(i&&console.log(`Moulinette FileUtil | Root: ${o.dirs.length} subfolders found.`),o.files.find((e=>e.endsWith("/ignore.info"))))return i&&console.log("Moulinette FileUtil | File ignore.info found. Stop scanning."),a;for(const e of o.dirs)i&&console.log(`Moulinette FileUtil | Root: processing publisher ${e}...`),a.push({publisher:decodeURIComponent(e.split("/").pop()),packs:await n.scanAssetsInPublisherFolder(s,decodeURIComponent(e),t,i)});return a}static getMoulinetteSources(){const e=[],t=Array.isArray(game.settings.get("moulinette","sources"))?game.settings.get("moulinette","sources"):[];for(const s of t)s.auto||e.push({type:s.type,forceRefresh:s.forceRefresh,publisher:s.creator,pack:s.pack,filters:s.filters,source:s.source,path:s.path});for(const s of game.moulinette.sources){const i=t.find((e=>e.auto&&e.source==s.source&&e.path==s.path&&e.type==s.type));i&&!i.enabled||e.push({type:s.type,forceRefresh:i?i.forceRefresh:s.forceRefresh,publisher:i&&i.creator?i.creator:s.publisher,pack:i&&i.pack?i.pack:s.pack,filters:s.filters,source:s.source,path:s.path})}return e}static async updateSourceIndex(e,t,s){const i=game.settings.get("moulinette-core","debugScanAssets"),a=n.getMoulinetteSources();for(const o of a){const a=await n.getBaseURL(o.source);if(o.type==t){if(!(o.publisher&&o.pack&&o.path&&o.source)){console.warn("Moulinette FileUtil | Invalid moulinette source!",o);continue}const t=`${o.type}:${o.source}:${o.path}`,l=s.filter((e=>!o.filters||o.filters.includes(e)));if(console.info(`Moulinette FileUtil | Indexing ${o.path} using filters: ${l}`,o),t in e&&!o.forceRefresh){console.warn(game.i18n.format("mtte.indexNoRefresh",{path:o.path}));continue}let r=[];if("*"==o.publisher)r=await n.scanAssets(o.path,l,o.source);else if("*"==o.pack)r=[{publisher:o.publisher,packs:await n.scanAssetsInPublisherFolder(o.source,o.path,l,i)}];else{const e=await n.scanAssetsInPackFolder(o.source,o.path,l,i);r=[{publisher:o.publisher,packs:[{name:o.pack,source:o.source,path:a+o.path,assets:e,isLocal:n.LOCAL_SOURCES.includes(o.source)}]}]}e[t]=r}}}static async scanAssetsInPublisherFolder(e,t,s,i=!1){let a=[];i&&console.log(`Moulinette FileUtil | Publisher: scanning ${t} ...`);let o=await FilePicker.browse(e,t,n.getOptions());if(i&&console.log(`Moulinette FileUtil | Publisher: ${o.dirs.length} subfolders found.`),o.files.find((e=>e.endsWith("/ignore.info"))))return i&&console.log("Moulinette FileUtil | File ignore.info found. Stop scanning."),a;for(const t of o.dirs){i&&console.log(`Moulinette FileUtil | Publisher: processing pack ${t}...`);const o={name:decodeURIComponent(t.split("/").pop()),path:t,source:e,isLocal:n.LOCAL_SOURCES.includes(e),assets:await n.scanAssetsInPackFolder(e,decodeURIComponent(t),s,i)};const l=(await FilePicker.browse(e,decodeURIComponent(t),n.getOptions())).files.find((e=>e.endsWith("/moulinette.json")));if(l){i&&console.log(`Moulinette FileUtil | Analyzing ${l} file...`);const e=await fetch(l+"?ms="+Date.now(),{cache:"no-store"}).catch((function(e){console.log("MoulinetteFileUtil | Cannot download tiles/asset list",e)}));if(200!=e.status)continue;let t={};try{t=await e.json(),o.meta=t,i&&console.log("Moulinette FileUtil | PackEntry meta",t)}catch(e){console.warn(`${l} not processed.`,e)}}a.push(o)}return a}static async scanAssetsInPackFolder(e,t,s,i=!1){let a=[];try{a=await n.scanFolder(e,t,s,i)}catch(e){console.error(`MoulinetteFileUtil | Not able to scan assets in ${t}`,e)}return a=a.filter((e=>e.indexOf("_thumb")<0)),i&&console.log(`Moulinette FileUtil | Pack: ${a.length} assets found.`),"undefined"!=typeof ForgeVTT&&ForgeVTT.usingTheForge&&"public"!=e?a.map((e=>decodeURIComponent(e))):a.map((e=>decodeURIComponent(e).split(decodeURIComponent(t))[1].substring(1)))}static async scanAssetsInCustomFolders(e,t){"."==e&&(e="");const s=game.settings.get("moulinette-core","debugScanAssets");let i=[];const a=await n.getBaseURL(),o=n.getSource();s&&console.log(`Moulinette FileUtil | Scanning custom folder ${e} for .mtte files...`);let l=await n.scanFolder(o,e,".mtte");for(const e of l){s&&console.log(`Moulinette FileUtil | Analyzing ${e} file...`);const l=await fetch(e+"?ms="+Date.now(),{cache:"no-store"}).catch((function(e){console.log("MoulinetteFileUtil | Cannot download configuration file",e)}));if(200!=l.status)continue;let r={};try{r=await l.json()}catch(t){console.warn(`${e} not processed.`,t)}let c=e.substring(0,e.lastIndexOf("/"));if(a.length>0&&c.startsWith(a)&&(c=c.substring(a.length)),r.publisher&&r.publisher.length>=3&&!r.pack){s&&console.log("Moulinette FileUtil | Case #1. Publisher. Scanning subfolders as packs...");let e=await n.scanAssetsInPublisherFolder(o,c,t,s);if(e=e.filter((e=>e.assets.length>0)),e.length>0){const t=i.find((e=>e.publisher==r.publisher));t?t.packs.push(...e):i.push({publisher:r.publisher,packs:e})}}else if(r.publisher&&r.publisher.length>=3&&r.pack&&r.pack.length>=3){s&&console.log("Moulinette FileUtil | Case #2. Pack. Scanning files as assets...");const e={name:r.pack,path:c,assets:await n.scanAssetsInPackFolder(o,c,t,s)};if(e.assets.length>0){const t=i.find((e=>e.publisher==r.publisher));t?t.packs.push(e):i.push({publisher:r.publisher,packs:[e]})}}else{s&&console.log("Moulinette FileUtil | Case #3. Undefined. Scanning files as assets for unknown publisher and packs...");const e={name:game.i18n.localize("mtte.unknown"),path:c,assets:await n.scanAssetsInPackFolder(o,c,t,s)};if(e.assets.length>0){const t=i.find((e=>e.publisher==game.i18n.localize("mtte.unknown")));t?t.packs.push(e):i.push({publisher:game.i18n.localize("mtte.unknown"),packs:[e]})}}}return i}static async scanFolder(e,t,s,i=!1){let a=[];i&&console.log(`Moulinette FileUtil | Assets: scanning ${t} ...`);const o=await FilePicker.browse(e,t,n.getOptions());if(o.files.find((e=>e.endsWith("/ignore.info"))))return i&&console.log("Moulinette FileUtil | File ignore.info found. Stop scanning."),a;i&&console.log(`Moulinette FileUtil | Assets: ${o.files.length} assets found`);let l=s?o.files.filter((e=>s.includes(e.split(".").pop().toLowerCase()))):o.files;i&&console.log(`Moulinette FileUtil | Assets: ${l.length} assets kepts after filtering`),a.push(...l);for(const l of o.dirs){const o=decodeURIComponent(l);if(o.startsWith(t)){const t=await n.scanFolder(e,o,s,i);a.push(...t)}else i&&console.log(`Moulinette FileUtil | Assets: ignoring ${o} which is NOT a subfolder of ${t} as expected!`)}return a}static getSASExpiration(e){if(Array.isArray(e)||!e||0==e.length)return 1440;const t=decodeURIComponent(e.substring(3,e.indexOf("&"))),s=Date.parse(t)-Date.now();return Math.round(s/1e3/60)}static async buildAssetIndex(e,t=null){let s=[],i=[];if(game.moulinette.indexingInProgress)return{assets:s,packs:i};game.moulinette.indexingInProgress=!0;const a=game.settings.get("moulinette-core","enableMoulinetteCloud"),o=game.settings.get("moulinette-core","showCaseContent"),l=game.settings.get("moulinette","dataExclusions"),r={creators:[],packs:[]},c={creators:[],packs:[]};for(const e of Object.keys(l))if("*"in l[e])r.creators.push(e),c.creators.push(e);else for(const t of Object.keys(l[e]))isNaN(t)?c.packs.push(t):r.packs.push(Number(t));const u=new game.moulinette.applications.MoulinetteProgress(game.i18n.localize("mtte.indexingMoulinette"));u.render(!0);let d=0;for(let t of e){let l;if(u.setProgress(Math.round(d/e.length*100)),game.moulinette.cache.hasData(t))l=game.moulinette.cache.getData(t);else{if(!a&&t.startsWith(game.moulinette.applications.MoulinetteClient.SERVER_URL)){console.log("Moulinette FileUtil | Moulinette Cloud disabled ");continue}const e="?client=fvtt&ms="+(new Date).getTime();let s;if(s=t.startsWith(game.moulinette.applications.MoulinetteClient.SERVER_URL+"/assets/")?await fetch(t+e,{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},cache:"no-store",body:JSON.stringify({exclusions:r})}).catch((function(e){console.log("Moulinette FileUtil | Cannot download tiles/asset list",e)})):await fetch(t+e,{cache:"no-store"}).catch((function(e){console.log("Moulinette FileUtil | Cannot download tiles/asset list",e)})),!s||200!=s.status){t.indexOf("index-mtte.json")<0?(ui.notifications.warn(game.i18n.localize("mtte.errorBuildingAssetIndex")),console.warn(`Moulinette FileUtil | Couldn't load source ${t}. Response : `,s),console.warn("Moulinette FileUtil | Moulinette servers might be down?")):console.warn("Moulinette FileUtil | Moulinette couldn't find local index. You might want to index your assets.");continue}l=await s.json(),game.moulinette.cache.setData(t,l),l=duplicate(l)}if(!(l instanceof Array)){const e=[],t=n.getMoulinetteSources().map((e=>`${e.type}:${e.source}:${e.path}`));for(const s of Object.keys(l))(["global","default","specific"].includes(s)||t.includes(s))&&e.push(...l[s]);l=e}try{let e=1440;for(const a of l){if(a.packs.length>0){const t=n.getSASExpiration(a.packs[0].sas);if(e=Math.min(e,t),t<0){console.error(`Moulinette FileUtil | Your SAS token expired for ${a.publisher}.`);continue}t<30&&console.warn(`Moulinette FileUtil | Your SAS token is about to expire for ${a.publisher}. Only ${t} minutes remaining.`)}for(const e of a.packs){if(e.showCase&&!o)continue;const l=e.path.startsWith(n.REMOTE_BASE)||e.path.startsWith(n.REMOTE_BASE_S3);if(e.isLocal&&(c.creators.includes(a.publisher)||c.packs.includes(e.name)))continue;if(l&&(r.creators.includes(a.publisher)||r.packs.includes(e.id)))continue;const u={idx:d,packId:e.id,publisher:a.publisher,pubWebsite:a.website,name:e.name,url:e.url,license:e.license,licenseUrl:e.licenseUrl,path:e.path,count:e.assets.length,isLocal:e.isLocal,isFree:e.free,source:e.source,isRemote:l,isShowCase:e.showCase,deps:e.deps,sas:e.sas};for(let i=0;i<e.assets.length;i++){let a=e.assets[i];const o=Array.isArray(e.sas)?[e.sas[2*i],e.sas[2*i+1]]:null;if("string"==typeof a||a instanceof String){e.isLocal;let n={pack:d,filename:a,type:e.meta&&e.meta.type?e.meta.type:"img"};o&&(n.sas=o[0],n.sasTh=o[1]);const l=a.substring(a.lastIndexOf(".")+1);if("md"==l.toLocaleLowerCase()){u.count--;continue}if(t.indexOf("moulinette/scenes/custom")>=0)n.type="scene";else if(["ogg","mp3","wav","m4a","flac","webm","opus"].includes(l.toLocaleLowerCase())){if("webm"!=l||e.path.startsWith("moulinette/sounds/custom")||(s.push(duplicate(n)),u.count++),"webm"==l&&(u.isRemote||e.path.startsWith("moulinette/tiles/custom")||e.path.startsWith("moulinette/images/custom"))){u.count--;continue}n.type="snd",n.duration=e.durations&&e.durations.length>i?e.durations[i]:0}s.push(n)}else if("snd"==a.type){const t={pack:d,filename:a.path,type:a.type,duration:a.duration,loop:a.loop,title:a.title,cat:a.cat,order:a.order};if(o&&(t.sas=o[0],t.sasTh=o[1]),s.push(t),e.isLocal&&!e.path.startsWith("moulinette/sounds/custom")&&"webm"==a.path.substr(a.path.lastIndexOf(".")+1)){const t={pack:d,filename:a,type:e.meta&&e.meta.type?e.meta.type:"img"};o&&(t.sas=o[0],t.sasTh=o[1]),s.push(t),u.count++}}else{const e=a.path;delete a.path;const t={pack:d,filename:e||a.name,data:a,type:a.type};o&&(t.sas=o[0],t.sasTh=o[1]),s.push(t)}}i.push(u),d++}}e<=0?ui.notifications.error(game.i18n.localize("mtte.errorSASTokenExpired")):e<=30&&ui.notifications.warn(game.i18n.format("mtte.errorSASTokenAboutToExpire",{minutes:e}))}catch(e){console.log(`Moulinette FileUtil | Error building index of ${t}`,e)}}if(u.setProgress(100),t)for(const e of t)e.idx=d,i.push(e),d++;for(const e of i)if(e.depsPath=[],e.deps)for(const t of e.deps){const s=i.find((e=>e.path.endsWith("/"+t)));e.depsPath.push(s?{publisher:s.publisher,name:s.name,path:s.path}:"")}return game.moulinette.indexingInProgress=!1,{assets:s,packs:i}}static foldersFromIndex(e,t,s=!1){if(0==e.length)return{};let i={},a=0;for(const t of e){a++;const e=t.filename.lastIndexOf("/");let o=e<0?"":t.filename.substring(0,e);s&&(o=o.split("/").pop()),o+="/",t.idx=a,o in i?i[o].push(t):i[o]=[t]}return i}static foldersFromIndexImproved(e,t){if(0==e.length)return{};let s={},i=0;const a=e.reduce(((e,s)=>e.add(t[s.pack].publisher)),new Set),o=e.reduce(((e,t)=>e.add(t.pack)),new Set);for(const n of e){i++;const e=a.size>1?t[n.pack].publisher:"",l=o.size>1?t[n.pack].name:"",r=n.filename?n.filename.replace(/json\/[^/]+\//g,""):"",c=r.lastIndexOf("/"),u=c<0?"":"/"+r.substring(0,c),d=`${decodeURIComponent(e)}##${decodeURIComponent(l)}##${decodeURIComponent(u)}`;n.idx=i,s.hasOwnProperty(d)?s[d].push(n):s[d]=[n]}return s}static getMoulinetteBasePath(e,t,s){return`moulinette/${e}/${n.generatePathFromName(t)}/${n.generatePathFromName(s)}/`}static async downloadAssetDependencies(e,t,s,i=!1){const a=n.getMoulinetteBasePath(s,t.publisher,t.name);if(e.data&&"img"!=e.type||(e={data:{deps:[e.filename],eDeps:{}},sas:e.sas}),await n.downloadDependencies(e.data.deps,t.path,e.sas,a,i),e.data.eDeps)for(const[a,o]of Object.entries(e.data.eDeps)){const l=Number(a);if(l>=0&&l<t.depsPath.length){const a=t.depsPath[l],r=n.getMoulinetteBasePath(s,a.publisher,a.name);await n.downloadDependencies(o,a.path,e.sas,r,i)}else console.error("Moulinette FileUtil | Invalid external dependency "+l)}let o=[];const l=await n.getBaseURL();o.push(l+a);for(const e of t.deps)o.push(l+n.getMoulinetteBasePath(s,t.publisher,e));return o}static async downloadDependencies(e,t,s,i,a=!1){let o=[];if(!e||0==e.length)return o;const l=new game.moulinette.applications.MoulinetteProgress(game.i18n.format("mtte.downloadDependencies",{count:e.length}));l.render(!0);let r=0,c=0,u="";for(const d of e){r++;const h=i+d,m=decodeURIComponent(h.substring(0,h.lastIndexOf("/"))),g=decodeURIComponent(d.split("/").pop()),p=t+"/"+d+s;await n.downloadFile(p,m,g,a,o)||(c++,ui.notifications.error(game.i18n.localize("mtte.errorDownload"))),u=game.i18n.format("mtte.downloadDependenciesMessage",{succ:r-c,failed:c,succRate:Math.round(100*(r-c)/e.length),failRate:Math.round(100*c/e.length)}),l.setProgress(100*r/e.length,u)}return l.setProgress(100),console.log(`Moulinette FileUtil | ${u}`),o}static async getAvailableAssets(e){let t={};const s=game.moulinette.applications.MoulinetteClient.SERVER_URL+("tiles"==e?"/static/available.json":"/static/available-scenes.json");if(game.moulinette.cache.hasData(s))return game.moulinette.cache.getData(s);{const e=await fetch(s).catch((function(e){console.warn(`MoulinetteClient | Cannot establish connection to server ${MoulinetteClient.SERVER_URL}`,e)}));return e&&200==e.status?(t=await e.json(),game.moulinette.cache.setData(s,t),t):t}}static async getAvailableMatchesMoulinetteCloud(e,t,s=!0){const i=game.settings.get("moulinette-core","enableMoulinetteCloud"),a=game.settings.get("moulinette-core","showCloudContent");if(!i||!a)return s?0:[];const o=`${e}#${t}`;if(game.moulinette.cloud.lastSearch.key==o&&(s||game.moulinette.cloud.lastSearch.packs))return game.moulinette.cloud.lastSearch;const n=game.moulinette.applications.MoulinetteClient.SERVER_URL+`/api/marketplace/search?type=${t}&terms=${encodeURIComponent(e)}&list=${!s}`,l=await fetch(n).catch((function(e){console.warn(`MoulinetteClient | Cannot establish connection to server ${MoulinetteClient.SERVER_URL}`,e)}));if(!l||200!=l.status)return 0;const r=await l.json();return game.moulinette.cloud.lastSearch=r,game.moulinette.cloud.lastSearch.key=o,r}static async getAvailableMatches(e,t,s=[]){const i=await n.getAvailableAssets(t),a=[],o=game.settings.get("moulinette-core","enableMoulinetteCloud"),l=game.settings.get("moulinette-core","showCloudContent");if(!o||!l)return a;if(0==e.trim().length)return a;e=e.split(" ");for(const[t,o]of Object.entries(i))for(const i of o){if(s.find((e=>e.name==i.name&&e.publisher==t)))continue;const o=i.assets.filter((t=>{for(const s of e)if(t.toLowerCase().indexOf(s.toLowerCase())<0)return!1;return!0}));o.length>0&&a.push({creator:t,pack:i.name,matches:o})}return a}static b64toBlob(e){const t=e.split(";base64,"),s=t[0].split(":")[1],i=atob(t[1]),a=[];for(let e=0;e<i.length;e+=512){const t=i.slice(e,e+512),s=new Array(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);const o=new Uint8Array(s);a.push(o)}return new Blob(a,{type:s})}static async downloadFile(e,t,s,i=!1,a=[]){t=decodeURIComponent(t),s=decodeURIComponent(s),await n.createFolderRecursive(t);const o=(await FilePicker.browse(n.getSource(),t)).files.map((e=>decodeURIComponent(e))),l=t+(t.endsWith("/")?"":"/")+s;if(!i&&o.includes(l))return!0;let r=0;const c=(""+e).split("?")[0];for(;r<=n.RETRIES;){r>0&&console.log(`Moulinette FileUtil | ${r}# retry of downloading ${c}`);try{let o=await fetch(e);if(o&&200==o.status){const e=await o.blob(),l=await n.uploadFile(new File([e],s,{type:e.type,lastModified:new Date}),s,t,i);if(l&&"success"==l.status)return a.push(l),!0;console.warn(`Moulinette FileUtil | MTTERR003 Download succeeded but upload failed for ${c}`,l)}else console.warn(`Moulinette FileUtil | MTTERR001 Download failed for ${c}`,o)}catch(e){console.error(`Moulinette FileUtil | MTTERR002 Download throws exception for ${c}`,e)}r++}return!1}static async uploadToMoulinette(e,t,s,i){const a=await game.moulinette.applications.Moulinette.getUser(),o=(new game.moulinette.applications.MoulinetteClient,new FormData);o.set("file",e),o.set("path",decodeURIComponent(t)),o.set("state",s),o.set("pack",i);try{const e=await fetch(game.moulinette.applications.MoulinetteClient.SERVER_URL+"/byoa/files/upload/"+a.id,{method:"POST",body:o});if(200!=e.status)return console.error("Moulinette FileUtil | File upload to Moulinette Cloud failed",e),!1}catch(e){return console.error("Moulinette FileUtil | File upload to Moulinette Cloud failed",e),!1}return!0}static findLongestCommonBase(e){if(!e||e.length<=1)return"";let t=null;for(const i of e)if("string"==typeof i||i instanceof String){if(null==t){t=i;continue}let e=t.length;for(var s=0;s<t.length;s++)if(s>=i.length||t[s]!=i[s]){e=s;break}t=t.substring(0,e)}null==t&&(t="");const i=t.lastIndexOf("/");return i>0?t.substring(0,i):""}static async updateIndex(e,t,s,i,a=!0){const o="index-mtte.json",l=`${await n.getBaseURL()}${s}/${o}`;let r={};const c="?ms="+(new Date).getTime(),u=await fetch(l+c,{cache:"no-store"}).catch((function(e){console.error(`Moulinette FileUtil | Exception while downloading index ${l}`,e)}));if(u&&200==u.status&&(r=await u.json()),a){const e=game.settings.get("moulinette-core","customPath");e&&(r.global=await n.scanAssetsInCustomFolders(e,i))}r.default=await n.scanAssets(s,i),await n.updateSourceIndex(r,t,i),r.specific=await e.indexAssets();for(const e in r)if(r[e]){for(const t of r[e])for(const e of t.packs){const t=n.findLongestCommonBase(e.assets);t.length>0&&(e.path=t.startsWith("http")?t:e.path+"/"+t,e.assets=e.assets.map((e=>e.substring(t.length+1))))}if("sounds"==t){const t=new Audio;t.preload="metadata";for(const s of r[e])for(const e of s.packs){const s=[];for(const i of e.assets){t.src=i.match(/^https?:\/\//)?i:`${e.path}/${n.encodeURL(i)}`;const a=new Promise(((e,s)=>{t.onloadedmetadata=function(){e(t.duration)},t.onerror=function(){console.warn(`Moulinette FileUtil | Audio file '${decodeURIComponent(t.src)}' seems corrupted`),e(0)}})),o=await a;s.push(Math.round(o))}e.durations=s}}if("scenes"==t)if(game.settings.get("moulinette-scenes","generateThumbnails"))for(const t of r[e])for(const e of t.packs){const t=await n.getBaseURL(e.source);for(const s of e.assets)if("string"==typeof s||s instanceof String){if(s.indexOf("_thumb")>0)continue;let i=e.path.length>0?`${e.path}/${s}`:s;t.length>0&&i.startsWith(t)&&(i=i.substring(t.length));const a=decodeURIComponent("moulinette/thumbs/"+i.substring(0,i.lastIndexOf("."))+"_thumb.webp"),o=a.split("/").pop(),l=a.substring(0,a.lastIndexOf("/"));try{if(console.log(`Moulinette FileUtil | Creating thumbnail for ${i}`),await n.fileExists(`${l}/${o}`)){console.log(`Moulinette FileUtil | 👍 Thumbnail ${l}/${o} already exists. Skipping.`);continue}const e=(await fetch(t+i,{method:"HEAD"})).headers.get("content-length");if(e>n.MAX_THUMB_FILESIZE){console.warn(`Moulinette FileUtil | ⚠ File too large (${e}). Thumbnail generation skipped.`);continue}const s=await ImageHelper.createThumbnail(t+i,{width:400,height:400,center:!0,format:"image/webp"}),a=await fetch(s.thumb),r=await a.arrayBuffer(),c=new File([r],o,{type:"image/webp"});await n.uploadFile(c,o,l,!0);for(const e of PIXI.Assets.cache._cacheMap.keys())await PIXI.Assets.unload(e);console.log(`Moulinette FileUtil | Thumbnail ${o} `)}catch(e){console.warn(`Moulinette FileUtil | Failed to create thumbnail for ${i}.`,e)}}}else console.warn("Moulinette FileUtil | Thumbnails generation skipped!")}await n.uploadFile(new File([JSON.stringify(r)],o,{type:"application/json",lastModified:new Date}),o,s,!0)}static getThumbnailURLMoulinetteCloud(e,t){if(e&&t&&e.isRemote){const s=`${e.path}/${t.filename}`.replace(n.REMOTE_BASE,n.REMOTE_BASE_S3+"/mttethumbs");return s.substring(0,s.lastIndexOf("."))+"_thumb.webp"}return null}}class l extends FilePicker{static MAX_ASSETS=100;constructor(e={}){super(e)}async browse(e,t={}){if(game.world&&!game.user.can("FILES_BROWSE"))return;const s=game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT);if(!(this.options&&this.options.forceDefault||s)&&["image","imagevideo"].includes(this.type)&&!this.default){const t=game.moulinette.forge.filter((e=>"tiles"==e.id));if(t&&1==t.length)return this.picker=new r(t[0],{type:this.type,callbackSelect:this._onSelect.bind(this),callbackDefault:this._onDefault.bind(this,e)}),void this.picker.render(!0)}return super.browse(e,t)}async _onSelect(e){return e?(this.field&&(this.field.value=e,this.field.dispatchEvent(new Event("change"))),this.callback&&this.callback(e,this),this.picker.close()):ui.notifications.error("You must select a file to proceed.")}async _onDefault(e){return this.default=!0,super.browse(e)}}class r extends FormApplication{static MAX_ASSETS=100;constructor(e,t={}){super(),this.assetInc=0,this.activeModule=e,this.type=t.type,this.search=t.search,this.callback=t.callbackSelect,this.defaultUI=t.callbackDefault}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinette",classes:["mtte","forge"],title:game.i18n.localize("mtte.moulinetteFilePicker"),template:"modules/moulinette-core/templates/filepicker.hbs",width:880,height:800,resizable:!0,closeOnSubmit:!1,submitOnClose:!1})}async getData(){const e=game.settings.get("moulinette-core","cloudColor");let t={},s=await this.activeModule.instance.getPackList();s=s.sort(((e,t)=>e.publisher==t.publisher?e.name>t.name?1:-1:e.publisher>t.publisher?1:-1));let i=0,a=!1;s.forEach((e=>{e.special?a=!0:i+=e.count,e.publisher in t?(t[e.publisher].count+=e.count,e.isRemote&&(t[e.publisher].isRemote=!0)):t[e.publisher]={name:e.publisher,count:e.count,isRemote:e.isRemote,special:e.special}})),Object.keys(t).forEach((s=>{const i=t[s];i.isRemote&&"def"==e&&(i.class="cloud"),i.isRemote&&"contrast"==e&&(i.class="cloud contrast")})),t=Object.values(t).filter((e=>e.special||e.count>0)).sort(((e,t)=>e.name>t.name)),s=duplicate(s.filter((e=>e.count>0&&!(this.search&&this.search.creator&&e.publisher!=this.search.creator)||e.special)));for(const e of s)e.cleanName=e.name.startsWith(e.publisher)?e.name.substring(e.publisher.length).trim():e.name;if(this.search&&this.search.creator){t.find((e=>e.name==this.search.creator)).selected="selected"}let o=this.search&&this.search.creator?this.search.creator:null,n=-1,l=null;this.search&&this.search.pack&&(l=s.find((e=>e.name.toLowerCase().startsWith(this.search.pack.toLowerCase()))),l&&(n=l.idx,l.selected="selected"));const c=this.search&&this.search.terms?this.search.terms:"";this.assets=await this.activeModule.instance.getAssetList(c,n,o);const u={terms:c,user:await game.moulinette.applications.Moulinette.getUser(),supportsModes:this.activeModule.instance.supportsModes(),supportsThumbSizes:this.activeModule.instance.supportsThumbSizes(),supportsWholeWordSearch:this.activeModule.instance.supportsWholeWordSearch(),hidePacks:0==i,assetsCount:`${i.toLocaleString()}${a?"+":""}`,assets:this.assets.slice(0,r.MAX_ASSETS),dropdownModeAuto:"auto"==game.settings.get("moulinette-core","dropdownMode")};return u.publishers=t,u.packs=[],this.publishers=t.map((e=>e.name)),this.search=null,this.selCreator=null,this.selPack=-1,u}activateListeners(e){super.activateListeners(e),this.bringToTop(),e.find("#search").focus(),e.find(".sOptions a").click(this._onSearchOptions.bind(this)),game.settings.get("moulinette","wholeWordSearch")&&e.find(".sOptions a.wholeWord").addClass("active"),e.find("button").click(this._onClickButton.bind(this)),e.find(".fvtt-picker").click(this._onClickButton.bind(this)),e.find(".display-modes a").click(this._onChangeDisplayMode.bind(this)),e.find(".thumbsizes a").click(this._onChangeThumbsizes.bind(this));const t=game.settings.get("moulinette","displayMode");e.find(`.display-modes .mode-${t}`).addClass("active");const s=this;e.find(".filterList.creators a").click((async function(e){e.preventDefault();const t=e.currentTarget;s._onCreatorSelected($(t).closest("li").data("id"),$(t).closest(".top"))})),e.find(".filterCombo.creators").change((function(e){e.preventDefault();const t=$(this).find(":selected").val();s._onCreatorSelectedDropDown(t)})),e.find(".filterList.packs a").click((async function(e){e.preventDefault();game.moulinette.applications.Moulinette;const t=e.currentTarget;s._onPackSelected($(t).closest("li").data("id"),$(t).closest(".top"))})),e.find(".filterCombo.packs").change((async function(e){e.preventDefault(),s.selPack=$(this).find(":selected").val(),await s._searchAssets()})),e.find(".filterList.creators").keydown((function(t){t.originalEvent;if("Tab"==t.key)t.preventDefault(),e.find(t.shiftKey?"#search":".filterList.packs").focus();else if("ArrowDown"==t.key||"ArrowUp"==t.key){t.preventDefault();const e=Math.max(-1,s.publishers.indexOf(s.selCreator)),i=Math.min(Math.max(-1,e+("ArrowDown"==t.key?1:-1)),s.publishers.length-1);s._onCreatorSelected(i<0?"-1":s.publishers[i],$(t.currentTarget).closest(".top"))}})),e.find(".filterList.packs").keydown((function(t){t.originalEvent;if("Tab"==t.key)t.preventDefault(),e.find(t.shiftKey?".filterList.creators":"#search").focus();else if("ArrowDown"==t.key||"ArrowUp"==t.key){t.preventDefault();const e=Math.max(-1,s.packs.findIndex((e=>e.id==s.selPack))),i=Math.min(Math.max(-1,e+("ArrowDown"==t.key?1:-1)),s.packs.length-1);s._onPackSelected(i<0?"-1":s.packs[i].id,$(t.currentTarget).closest(".top"))}})),this.activeModule.instance.activateListeners(e,this.callback,this.type),e.find(".expand").click(this._onToggleExpand.bind(this)),e.find(".list").on("scroll",this._onScroll.bind(this)),e.find(".list").css("bottom","80px");$(".filterList > li").hover((function(){const e=$(this),t=e.find("ul"),s=e.find("a"),i=1*t.height()/400;e.data("origHeight",e.height()),s.addClass("hover"),t.show().css({paddingTop:e.data("origHeight")}),i>1&&e.css({height:400,overflow:"hidden"}).mousemove((function(s){var a=e.offset(),o=(s.pageY-a.top)*i-e.data("origHeight")*i;o>e.data("origHeight")&&t.css("top",-o+e.data("origHeight"))}))}),(function(){$(this).height($(this).data("origHeight")).find("ul").css({top:0}).hide().end().find("a").removeClass("hover")})),this.html=e}async _onCreatorSelectedDropDown(e){const t=game.moulinette.applications.Moulinette;this.selCreator=e&&"-1"!=e?e:null,this.selPack="-1";let s=await this.activeModule.instance.getPackList();s=s.filter((e=>e.count>0));s.reduce(((e,t)=>e+t.count),0);this.selCreator&&(s=t.optimizePacks(s.filter((t=>t.publisher==e))));const i=game.settings.get("moulinette-core","cloudColor");this.packs=[];let a=`<option value="-1">${game.i18n.localize("mtte.allPacks")}</option>`;if(this.selCreator){const e=Object.keys(s).sort(((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase())));for(const o of e){const e=s[o].reduce(((e,t)=>e+t.count),0),n=s[o].reduce(((e,t)=>e+(e.length>0?",":"")+t.idx),""),l=s[o].reduce(((e,t)=>e&&t.isRemote),!0);let r="";l&&"def"==i&&(r="cloud"),l&&"contrast"==i&&(r="cloud contrast");const c=t.prettyText(o);a+=`<option value="${n}" class="${r}">${t.prettyText(c)} (${t.prettyNumber(e)})</option>`,this.packs.push({id:n,name:c})}}this.html.find(".filterCombo.packs").html(a),await this._searchAssets()}async _onCreatorSelected(e,t){const s=game.moulinette.applications.Moulinette;this.selCreator=e&&"-1"!=e?e:null,this.selPack="-1",this.html.find("#creatorName").text(this.selCreator?e:game.i18n.localize("mtte.chooseCreator")),t.height(t.data("origHeight")),this.html.find("#packName").text(game.i18n.localize("mtte.choosePack"));let i=await this.activeModule.instance.getPackList();i=i.filter((e=>e.count>0));const a=i.reduce(((e,t)=>e+t.count),0);this.selCreator&&(i=s.optimizePacks(i.filter((t=>t.publisher==e))));const o=game.settings.get("moulinette-core","cloudColor");this.packs=[];let n=`<li data-id="-1" class="all"><a>${game.i18n.localize("mtte.allPacks")} (${s.prettyNumber(a)})</a></li>`;if(this.selCreator){const e=Object.keys(i).sort(((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase())));for(const t of e){const e=i[t].reduce(((e,t)=>e+t.count),0),a=i[t].reduce(((e,t)=>e+(e.length>0?",":"")+t.idx),""),l=i[t].reduce(((e,t)=>e&&t.isRemote),!0);let r="";l&&"def"==o&&(r="cloud"),l&&"contrast"==o&&(r="cloud contrast");const c=s.prettyText(t);n+=`<li data-id="${a}" class="${r}"><a><i class="fas fa-${l?"cloud":"desktop"}"></i> ${s.prettyText(c)} (${s.prettyNumber(e)})</a></li>`,this.packs.push({id:a,name:c})}}n+='<li class="filler"></li>',this.html.find(".filterList.packs .sub_menu").html(n),await this._searchAssets(),this.html.find(".filterList.creators").focus()}async _onPackSelected(e,t){if(this.selPack=e,this.selPack){const s=this.packs.find((t=>t.id==e));this.html.find("#packName").text(s?s.name:game.i18n.localize("mtte.choosePack")),t.height(t.data("origHeight")),await this._searchAssets(),this.html.find(".filterList.packs").focus()}}async _onClickButton(e){e.preventDefault();const t=e.currentTarget;t.classList.contains("search")?await this._searchAssets():t.classList.contains("fvtt-picker")&&(this.defaultUI(),this.close())}async _onSearchOptions(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("wholeWord")){$(t).toggleClass("active");const e=$(t).hasClass("active");await game.settings.set("moulinette","wholeWordSearch",e),ui.notifications.info(game.i18n.localize(e?"mtte.wholeWordEnabled":"mtte.wholeWordDisabled")),this._searchAssets()}}async _searchAssets(){const e=this.html.find("#search").val().toLowerCase();this.assets=await this.activeModule.instance.getAssetList(e,this.selPack,this.selCreator);const t=this.activeModule.instance.supportsModes();if(this.expand=!0,0==this.assets.length&&0==e.length)this.html.find(".list").html(`<div class="error">${game.i18n.localize("mtte.specialSearch")}</div>`);else if(0==this.assets.length)this.html.find(".list").html(`<div class="error">${game.i18n.localize("mtte.noResult")}</div>`);else{const e=game.settings.get("moulinette","displayMode");let s=t&&"browse"==e?this.assets.filter((e=>e.indexOf('class="folder"')>0)):this.assets.slice(0,l.MAX_ASSETS).join("");1==s.length&&"browse"==e&&(s=this.assets,this.expand=!1),0==s.length&&"browse"==e?this.html.find(".list").html(`<div class="error">${game.i18n.localize("mtte.errorBrowseUpdateModule")}</div>`):this.html.find(".list").html(s),this.ignoreScroll=t&&"browse"==e,this.assetInc=0}this._reEnableListeners(),this.setPosition()}async _onToggleExpand(e){e.preventDefault();const t=e.currentTarget,s=$(t).closest(".folder"),i=(s.data("path"),s.data("idx"));if(!this.expand||s.hasClass("expanded"))return void s.find("div:not(.bc)").toggle();let a=[];if(i){const e=`data-folder="${i}"`;for(const t of this.assets)t.indexOf(e)>0&&a.push(t)}s.append(a),s.addClass("expanded"),this._reEnableListeners()}async _onScroll(e){if(this.ignoreScroll)return;const t=$(e.currentTarget).prop("scrollHeight")-$(e.currentTarget).scrollTop(),s=$(e.currentTarget).height();this.assets&&t-20<s&&(this.ignoreScroll=!0,this.assetInc*r.MAX_ASSETS<this.assets.length&&(this.assetInc++,this.html.find(".list").append(this.assets.slice(this.assetInc*r.MAX_ASSETS,(this.assetInc+1)*r.MAX_ASSETS)),this._reEnableListeners()),this.ignoreScroll=!1)}_reEnableListeners(){this.html.find("*").off(),this.activateListeners(this.html),this._activateCoreListeners(this.html)}async _onChangeDisplayMode(e){e.preventDefault();let t="tiles";const s=e.currentTarget;s.classList.contains("mode-list")?t="list":s.classList.contains("mode-browse")&&(t="browse"),this.ignoreScroll="browse"==t,await game.settings.set("moulinette","displayMode",t),this.html.find(".display-modes a").removeClass("active"),this.html.find(`.display-modes a.mode-${t}`).removeClass("active"),this._searchAssets()}async _onChangeThumbsizes(e){e.preventDefault();const t=e.currentTarget;this.activeModule.instance.onChangeThumbsSize(t.classList.contains("plus"))}}class c{static SERVER_URL="https://assets.moulinette.cloud";static GITHUB_SRC="https://raw.githubusercontent.com/SvenWerlen/moulinette-data";static HEADERS={Accept:"application/json","Content-Type":"application/json"};async fetch(e,t,s){let i={method:t,headers:c.HEADERS};s&&(i.body=JSON.stringify(s));return await fetch(`${c.SERVER_URL}${e}`,i).catch((function(e){console.log(`MoulinetteClient | Cannot establish connection to server ${c.SERVER_URL}`,e)}))}async send(e,t,s){const i=await this.fetch(e,t,s);return i?{status:i.status,data:await i.json()}:null}async get(e){return this.send(e,"GET")}async put(e){return this.send(e,"PUT")}async post(e,t){return this.send(e,"POST",t)}async delete(e,t){return this.send(e,"DELETE")}}class u extends FormApplication{constructor(e,t={}){super(),this.module=e,this.filters=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinette-shortcuts",classes:["mtte","shortcuts"],title:game.i18n.localize("mtte.moulinetteShortcuts"),template:"modules/moulinette-core/templates/shortcuts.hbs",width:600,height:"auto",resizable:!0,dragDrop:[{dragSelector:".draggable"}],closeOnSubmit:!1,submitOnClose:!1})}async getData(){const e=`game.moulinette.applications.MoulinetteAPI.searchUI("${this.module}", ${JSON.stringify(this.filters,null,3)});`;let t=`@Macro[${"Mou"+this.module.charAt(0).toUpperCase()+this.module.slice(1)}]{${this.filters.terms}`;return t+="|"+(this.filters.creator?this.filters.creator:""),t+="|"+(this.filters.pack?this.filters.pack:"")+"}",{macroCode:e,macroJournalCode:t}}activateListeners(e){super.activateListeners(e),this.bringToTop(),e.find("button").click(this._onClickButton.bind(this)),this.html=e}_onDragStart(e){super._onDragStart(e);const t=this.html.find("#codeMacro").val();let s={type:"Macro",data:{name:"Moulinette UI shortcut",author:game.user.id,type:"script",img:"modules/moulinette-core/img/moulinette.png",command:t}};e.dataTransfer.setData("text/plain",JSON.stringify(s))}async _onClickButton(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("clipboardMacro")||t.classList.contains("clipboardJournal")){const e=this.html.find(t.classList.contains("clipboardMacro")?"#codeMacro":"#codeJournal").val();navigator.clipboard.writeText(e).then((()=>{ui.notifications.info(game.i18n.localize("mtte.codeCopiedClipboardSuccess"))})).catch((()=>{ui.notifications.warn(game.i18n.localize("mtte.codeCopiedClipboardFail"))}))}else if(t.classList.contains("createMacro")){const e=this.html.find("#codeMacro").val();(await Macro.create({name:"Moulinette UI shortcut",type:"script",img:"modules/moulinette-core/img/moulinette.png",command:e})).sheet.render(!0)}else if(t.classList.contains("createJournal")){const e=this.html.find("#codeJournal").val();(await JournalEntry.create({name:"Moulinette UI shortcut (article)",img:"modules/moulinette-core/img/moulinette.png",content:"This is a journal article sample: <br/><br/> "+e})).sheet.render(!0)}}}class d extends FormApplication{constructor(e,t){super(),this.filters=e,this.callback=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"mtteForgeFiltersDialog",classes:["mtte","options"],title:"",template:"modules/moulinette-core/templates/forge-filters.hbs",width:100,height:"auto",closeOnSubmit:!1,submitOnClose:!1})}getData(){return{options:this.filters}}activateListeners(e){const t=this;e.find(".applyFilters").click((s=>{s.preventDefault();const i=[];e.find("input:checkbox:checked").each(((e,t)=>{i.push($(t).val())})),t.callback&&t.callback(i),t.close()}))}}class h extends Application{constructor(){super()}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinette-exclusions",classes:["mtte","exclusions"],title:game.i18n.localize("mtte.manageContentVisibility"),template:"modules/moulinette-core/templates/exclusions.hbs",width:500})}async getData(){const e=game.settings.get("moulinette","dataExclusions"),t=[];for(const s of Object.keys(e)){const i={name:s,packs:[]};if(!("*"in e[s]))for(const t of Object.keys(e[s]))"*"!=t&&i.packs.push({id:t,name:e[s][t]}),i.packs.sort(((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase())));t.push(i)}return t.sort(((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase()))),{exclusions:t}}activateListeners(e){super.activateListeners(e),this.html=e,e.find(".actions a").click((e=>{e.preventDefault();const t=$(e.currentTarget).data("creator"),s=$(e.currentTarget).data("pack"),i=game.settings.get("moulinette","dataExclusions");t in i&&("*"==s?delete i[t]:s in i[t]&&(delete i[t][s],0==Object.keys(i[t])&&delete i[t])),game.settings.set("moulinette","dataExclusions",i).then((()=>this.render(!0)))})),e.find(".actions .export").click((()=>{const e=`moulinette-${game.world.id}-exclusions.json`,t=game.settings.get("moulinette","dataExclusions");saveDataToFile(JSON.stringify(t,null,2),"text/json",e)})),e.find(".actions .import").click((async()=>{const e=this;new Dialog({title:"Import Data: Moulinette Exclusions",content:await renderTemplate("templates/apps/import-data.html",{hint1:game.i18n.format("DOCUMENT.ImportDataHint1",{document:"exclusions"}),hint2:game.i18n.format("DOCUMENT.ImportDataHint2",{name:"this config"})}),buttons:{import:{icon:'<i class="fas fa-file-import"></i>',label:"Import",callback:t=>{const s=t.find("form")[0];if(!s.data.files.length)return ui.notifications.error("You did not upload a data file!");readTextFromFile(s.data.files[0]).then((t=>{game.settings.set("moulinette","dataExclusions",JSON.parse(t)).then((t=>e.render(!0)))}))}},no:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("mtte.cancel")}},default:"import"},{width:400}).render(!0)}))}}class m extends FormApplication{static MAX_ASSETS=100;static get TABS(){return game.moulinette.forge.map((e=>e.id))}constructor(e,t){super();const s=game.settings.get("moulinette","currentTab"),i=e||s;this.assetInc=0,this.tab=m.TABS.includes(i)?i:null,this.search=t,this.tab!=s&&game.settings.set("moulinette","currentTab",this.tab);for(const e of game.moulinette.forge)e.instance.clearCache();this.positionTimer=null}static get defaultOptions(){const e=game.settings.get("moulinette","winPosForge"),t=game.settings.get("moulinette-core","uiMode");return mergeObject(super.defaultOptions,{id:"moulinette",classes:["mtte","forge","compact"==t?"compact":"normal"],title:game.i18n.localize("mtte.moulinetteForge"),template:"modules/moulinette-core/templates/forge.hbs",width:e?e.width:880,height:e?e.height:800,left:e?e.left:null,top:e?e.top:null,resizable:!0,dragDrop:[{dragSelector:".draggable"}],closeOnSubmit:!1,submitOnClose:!1})}async getData(){const e=game.settings.get("moulinette-core","uiMode");if(0==game.moulinette.forge.length)return{error:game.i18n.localize("mtte.errorNoModule")};const t=game.modules.filter((e=>e.active&&game.moulinette.conflictingModules.includes(e.id)));t.length>0&&ui.notifications.warn(game.i18n.format("mtte.errorConflictingModules",{conflicting:t.map((e=>e.id)).join(", ")}));for(const e of game.moulinette.forge)e.active=this.tab==e.id,e.active&&(this.activeModule=e);if(this.activeModule||(this.activeModule=game.moulinette.forge[0],this.activeModule.active=!0),!game.user.isGM&&!this.activeModule.instance.supportsPlayersMode())return{error:game.i18n.localize("mtte.errorGMOnly")};const s=game.settings.get("moulinette-core","cloudColor"),i=this.activeModule.instance.getFilters();let a={},o=await this.activeModule.instance.getPackList();o=o.sort(((e,t)=>e.publisher==t.publisher?e.name>t.name?1:-1:e.publisher>t.publisher?1:-1));let n=0,l=!1;o.forEach((e=>{e.special?l=!0:n+=e.count,e.publisher in a?(a[e.publisher].count+=e.count,e.isRemote&&(a[e.publisher].isRemote=!0)):a[e.publisher]={name:e.publisher,count:e.count,isRemote:e.isRemote,special:e.special}})),Object.keys(a).forEach((e=>{const t=a[e];t.isRemote&&"def"==s&&(t.class="cloud"),t.isRemote&&"contrast"==s&&(t.class="cloud contrast")})),a=Object.values(a).filter((e=>e.special||e.count>0)).sort(((e,t)=>e.name>t.name)),o=duplicate(o.filter((e=>e.count>0&&!(this.search&&this.search.creator&&e.publisher!=this.search.creator)||e.special)));for(const e of o)e.cleanName=e.name.startsWith(e.publisher)?e.name.substring(e.publisher.length).trim():e.name;const r=game.settings.get("moulinette","moduleFilters"),c=this.activeModule.id,u=c in r?r[c]:[],d=this.search&&this.search.terms?this.search.terms:"";this.assets=d.length>0?await this.activeModule.instance.getAssetList(d,-1,null,u):[];const h={user:await game.moulinette.applications.Moulinette.getUser(),modules:game.moulinette.forge.sort(((e,t)=>e.name<t.name?-1:1)),activeModule:this.activeModule,supportsModes:this.activeModule.instance.supportsModes(),supportsThumbSizes:this.activeModule.instance.supportsThumbSizes(),supportsWholeWordSearch:this.activeModule.instance.supportsWholeWordSearch(),supportsShortcuts:["tiles","sounds","scenes","prefabs"].includes(this.activeModule.id),tooltipIndexing:["tiles","sounds","scenes","compendiums"].includes(this.activeModule.id),supportsFilters:i.length>0,filters:i,filtersEnabled:u.length>0,hidePacks:0==n,assetsCount:`${n.toLocaleString()}${l?"+":""}`,assets:this.assets.slice(0,m.MAX_ASSETS),footer:await this.activeModule.instance.getFooter(),terms:d,compactUI:"compact"==e,dropdownModeAuto:"auto"==game.settings.get("moulinette-core","dropdownMode"),disabled:!game.settings.get("moulinette-core","enableMoulinetteCloud")};return h.publishers=a,h.packs=[],this.publishers=a.map((e=>e.name)),this.selCreator=null,this.selPack=-1,h}activateListeners(e,s=!0){super.activateListeners(e);const i=this;this.noBringToTop||(this.bringToTop(),this.noBringToTop=!1),s&&e.find("#search").focus(),e.find(".tabs a").click(this._onNavigate.bind(this)),e.find(".sOptions a").click(this._onSearchOptions.bind(this)),game.settings.get("moulinette","wholeWordSearch")&&e.find(".sOptions a.wholeWord").addClass("active"),e.find(".mouCloudEnable").click((async function(e){e.preventDefault(),await game.settings.set("moulinette-core","enableMoulinetteCloud",!0),i.render()})),e.find("button").click(this._onClickButton.bind(this)),e.find(".shortcuts a").click(this._onGenerateShortcuts.bind(this)),e.find(".display-modes a").click(this._onChangeDisplayMode.bind(this)),e.find(".thumbsizes a").click(this._onChangeThumbsizes.bind(this)),e.find(".filters a").click(this._onFilters.bind(this)),e.find(".footerToggle a").click((t=>e.find(".footer").show())),e.find(".dataHiding a").click(this._onHideData.bind(this)),e.find(".mouAuthenticate").click((e=>(e.preventDefault(),new t(i).render(!0),!1)));const a=game.settings.get("moulinette","displayMode");e.find(`.display-modes .mode-${a}`).addClass("active"),e.find(".filterList.creators a").click((async function(e){e.preventDefault();const t=e.currentTarget;i._onCreatorSelected($(t).closest("li").data("id"),$(t).closest(".top"))})),e.find(".filterCombo.creators").change((function(e){e.preventDefault();const t=$(this).find(":selected").val();i._onCreatorSelectedDropDown(t)})),e.find(".filterList.packs a").click((async function(e){e.preventDefault();const t=e.currentTarget;i._onPackSelected($(t).closest("li").data("id"),$(t).closest(".top"))})),e.find(".filterCombo.packs").change((async function(e){e.preventDefault(),i.selPack=$(this).find(":selected").val(),await i._searchAssets()})),e.find(".filterList.creators").keydown((function(t){t.originalEvent;if("Tab"==t.key)t.preventDefault(),e.find(t.shiftKey?"#search":".filterList.packs").focus();else if("ArrowDown"==t.key||"ArrowUp"==t.key){t.preventDefault();const e=Math.max(-1,i.publishers.indexOf(i.selCreator)),s=Math.min(Math.max(-1,e+("ArrowDown"==t.key?1:-1)),i.publishers.length-1);i._onCreatorSelected(s<0?"-1":i.publishers[s],$(t.currentTarget).closest(".top"))}})),e.find(".filterList.packs").keydown((function(t){t.originalEvent;if("Tab"==t.key)t.preventDefault(),e.find(t.shiftKey?".filterList.creators":"#search").focus();else if("ArrowDown"==t.key||"ArrowUp"==t.key){t.preventDefault();const e=Math.max(-1,i.packs.findIndex((e=>e.id==i.selPack))),s=Math.min(Math.max(-1,e+("ArrowDown"==t.key?1:-1)),i.packs.length-1);i._onPackSelected(s<0?"-1":i.packs[s].id,$(event.currentTarget).closest(".top"))}})),this.activeModule&&this.activeModule.instance.activateListeners(e),e.find(".expand").click(this._onToggleExpand.bind(this)),e.find(".list").on("scroll",this._onScroll.bind(this));if($(".filterList > li").hover((function(){const e=$(this),t=e.find("ul"),s=e.find("a"),i=1*t.height()/400;e.data("origHeight",e.height()),s.addClass("hover"),t.show().css({paddingTop:e.data("origHeight")}),i>1&&e.css({height:400,overflow:"hidden"}).mousemove((function(s){var a=e.offset(),o=(s.pageY-a.top)*i-e.data("origHeight")*i;o>e.data("origHeight")&&t.css("top",-o+e.data("origHeight"))}))}),(function(){$(this).height($(this).data("origHeight")).find("ul").css({top:0}).hide().end().find("a").removeClass("hover")})),this.html=e,this.search&&this.search.creator){const t=this.search.creator;this.search.creator=null,this._onCreatorSelected(t,e.find(".filterList.creators .top"))}else if(this.search&&this.search.pack){const t=this.packs.find((e=>e.name==this.search.pack));this.search.pack=null,t&&this._onPackSelected(t.id,e.find(".filterList.packs .top"))}}async _onCreatorSelectedDropDown(e){const t=game.moulinette.applications.Moulinette;this.selCreator=e&&"-1"!=e?e:null,this.selPack="-1";let s=await this.activeModule.instance.getPackList();s=s.filter((e=>e.count>0));s.reduce(((e,t)=>e+t.count),0);this.selCreator&&(s=t.optimizePacks(s.filter((t=>t.publisher==e))));const i=game.settings.get("moulinette-core","cloudColor");this.packs=[];let a=`<option value="-1">${game.i18n.localize("mtte.allPacks")}</option>`;if(this.selCreator){const e=Object.keys(s).sort(((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase())));for(const o of e){const e=s[o].reduce(((e,t)=>e+t.count),0),n=s[o].reduce(((e,t)=>e+(e.length>0?",":"")+t.idx),""),l=s[o].reduce(((e,t)=>e&&t.isRemote),!0),r=s[o].reduce(((e,t)=>e&&t.isFree),!0);let c="";l&&"def"==i&&(c="cloud"),l&&"contrast"==i&&(c="cloud contrast");const u=t.prettyText(o);a+=`<option value="${n}" class="${c}">${t.prettyText(u)} ${r?"🎁 ":""}(${t.prettyNumber(e)})</option>`,this.packs.push({id:n,name:u})}}this.html.find(".filterCombo.packs").html(a),await this._searchAssets()}async _onCreatorSelected(e,t){const s=game.moulinette.applications.Moulinette;this.selCreator=e&&"-1"!=e?e:null,this.selPack="-1",this.html.find(`.filterCombo.creators option[value='${e}']`).prop("selected",!0),this.html.find("#creatorName").text(this.selCreator?e:game.i18n.localize("mtte.chooseCreator")),t.height(t.data("origHeight")),this.html.find("#packName").text(game.i18n.localize("mtte.choosePack"));let i=await this.activeModule.instance.getPackList();i=i.filter((e=>e.count>0));const a=i.reduce(((e,t)=>e+t.count),0);this.selCreator&&(i=s.optimizePacks(i.filter((t=>t.publisher==e))));const o=game.settings.get("moulinette-core","cloudColor");this.packs=[];let n=`<li data-id="-1" class="all"><a>${game.i18n.localize("mtte.allPacks")} (${s.prettyNumber(a)})</a></li>`,l=`<option value="-1">${game.i18n.localize("mtte.allPacks")} (${s.prettyNumber(a)})</option>`;if(this.selCreator){const e=Object.keys(i).sort(((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase())));for(const t of e){const e=i[t].reduce(((e,t)=>e+t.count),0),a=i[t].reduce(((e,t)=>e+(e.length>0?",":"")+t.idx),""),r=i[t].reduce(((e,t)=>e&&t.isRemote),!0),c=i[t].reduce(((e,t)=>e&&t.isFree),!0);let u="";r&&"def"==o&&(u="cloud"),r&&"contrast"==o&&(u="cloud contrast");const d=s.prettyText(t);n+=`<li data-id="${a}" class="${u}"><a><i class="fas fa-${r?"cloud":"desktop"}"></i> ${s.prettyText(d)} ${c?'<i class="fa-solid fa-gift"></i> ':""}(${s.prettyNumber(e)})</a></li>`,l+=`<option value="${a}" class="${u}">${s.prettyText(d)} (${s.prettyNumber(e)})</option>`,this.packs.push({id:a,name:d})}}n+='<li class="filler"></li>',this.html.find(".filterList.packs .sub_menu").html(n),this.html.find(".filterCombo.packs").empty().append(l),await this._searchAssets(),this.html.find(".filterList.creators").focus()}async _onPackSelected(e,t){if(this.selPack=e,this.selPack){const s=this.packs.find((t=>t.id==e));this.html.find("#packName").text(s?s.name:game.i18n.localize("mtte.choosePack")),this.html.find(`.filterCombo.packs option[value='${e}']`).prop("selected",!0),t.height(t.data("origHeight")),await this._searchAssets(),this.html.find(".filterList.packs").focus()}}async _onNavigate(e){e.preventDefault();const t=e.currentTarget.dataset.tab;if("byPack"==game.settings.get("moulinette-core","browseMode")){const e=this.html.find(".plist option:selected").val();if(e){let t=await this.activeModule.instance.getPackList();e in t&&(this.curPack=t[e].path)}}m.TABS.includes(t)&&(this.assets=[],this.tab=t,game.settings.set("moulinette","currentTab",t),this.render())}async _onSearchOptions(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("wholeWord")){$(t).toggleClass("active");const e=$(t).hasClass("active");await game.settings.set("moulinette","wholeWordSearch",e),ui.notifications.info(game.i18n.localize(e?"mtte.wholeWordEnabled":"mtte.wholeWordDisabled")),this._searchAssets()}}async _onClickButton(e){if(e.preventDefault(),this.activeModule){const t=e.currentTarget;if(t.classList.contains("search"))await this._searchAssets();else if(t.classList.contains("hidefooter"))this.html.find(".footer").hide();else if(t.classList.contains("exclusions"))(new h).render(!0);else{await this.activeModule.instance.onAction(t.classList)&&this.render()}}}async _searchAssets(){const e=this.html.find("#search").val().toLowerCase();console.log(`Moulinette | Searching ${e} with filters: ${this.selCreator} ${this.selPack}`);const t=game.settings.get("moulinette","moduleFilters"),s=this.activeModule.id,i=s in t?t[s]:[];this.assets=await this.activeModule.instance.getAssetList(e,this.selPack,this.selCreator,i);const a=this.activeModule.instance.supportsModes();if(this.expand=!0,0==this.assets.length&&0==e.length)this.html.find(".list").html(`<div class="error">${game.i18n.localize("mtte.specialSearch")}</div>`);else if(0==this.assets.length)this.html.find(".list").html(`<div class="error">${game.i18n.localize("mtte.noResult")}</div>`);else{const e=game.settings.get("moulinette","displayMode");let t=a&&"browse"==e?this.assets.filter((e=>e.indexOf('class="folder"')>0)):this.assets.slice(0,m.MAX_ASSETS).join("");1==t.length&&"browse"==e&&(t=this.assets,this.expand=!1),0==t.length&&"browse"==e?this.html.find(".list").html(`<div class="error">${game.i18n.localize("mtte.errorBrowseUpdateModule")}</div>`):this.html.find(".list").html(t),this.ignoreScroll=a&&"browse"==e,this.assetInc=0}this._reEnableListeners()}_onDragStart(e){super._onDragStart(e),this.activeModule&&this.activeModule.instance.onDragStart(e)}async _onToggleExpand(e){e.preventDefault();const t=e.currentTarget,s=$(t).closest(".folder"),i=(s.data("path"),s.data("idx"));if(!this.expand||s.hasClass("expanded"))return void s.find("div:not(.bc)").toggle();let a=[];if(i){const e=`data-folder="${i}"`;for(const t of this.assets)t.indexOf(e)>0&&a.push(t)}s.append(a),s.addClass("expanded"),this._reEnableListeners()}async _onScroll(e){if(this.ignoreScroll)return;const t=$(e.currentTarget).prop("scrollHeight")-$(e.currentTarget).scrollTop(),s=$(e.currentTarget).height();this.assets&&t-20<s&&(this.ignoreScroll=!0,this.assetInc*m.MAX_ASSETS<this.assets.length&&(this.assetInc++,this.html.find(".list").append(this.assets.slice(this.assetInc*m.MAX_ASSETS,(this.assetInc+1)*m.MAX_ASSETS)),this._reEnableListeners()),this.ignoreScroll=!1)}_reEnableListeners(){this.html.find("*").off(),this.activateListeners(this.html,!1),this._activateCoreListeners(this.html)}async _onChangeDisplayMode(e){e.preventDefault();let t="tiles";const s=e.currentTarget;s.classList.contains("mode-list")?t="list":s.classList.contains("mode-browse")&&(t="browse"),this.ignoreScroll="browse"==t,await game.settings.set("moulinette","displayMode",t),this.html.find(".display-modes a").removeClass("active"),this.html.find(`.display-modes a.mode-${t}`).removeClass("active"),this._searchAssets()}async _onChangeThumbsizes(e){e.preventDefault();const t=e.currentTarget;this.activeModule.instance.onChangeThumbsSize(t.classList.contains("plus"))}async _onGenerateShortcuts(e){e.preventDefault();e.currentTarget;const t=this.activeModule.id,s={terms:this.html.find("#search").val().toLowerCase()};if(this.selCreator&&(s.creator=this.selCreator),"-1"!=this.selPack){const e=this.packs.find((e=>e.id==this.selPack));e&&(s.pack=e.name)}new u(t,s).render(!0)}setPosition({left:e,top:t,width:s,height:i,scale:a}={}){super.setPosition({left:e,top:t,width:s,height:i,scale:a});const o=this;clearInterval(this.positionTimer),this.positionTimer=setInterval((function(){clearInterval(o.positionTimer);const e=game.settings.get("moulinette","winPosForge");e&&o.position.left==e.left&&o.position.top==e.top&&o.position.width==e.width&&o.position.height==e.height||(game.settings.set("moulinette","winPosForge",o.position),console.log("Moulinette Forge | Window position stored!"))}),2e3)}async _onFilters(e){e.preventDefault();const t=this,s=t.activeModule.id,i=game.settings.get("moulinette","moduleFilters"),a=s in i?i[s]:[],o=this.activeModule.instance.getFilters();for(const e of o)e.checked=a.includes(e.id);const n=new d(o,(async function(e){i[s]=e,await game.settings.set("moulinette","moduleFilters",i);const a=t.html.find(".filters a.filters");e.length>0?a.addClass("enabled"):a.removeClass("enabled"),t._searchAssets()}));n.position.left=e.pageX-n.position.width/2,n.position.top=e.pageY-120,n.render(!0)}_canDragStart(e){return!0}_onHideData(e){if(e.preventDefault(),!this.selCreator)return ui.notifications.warn(game.i18n.localize("mtte.errorNoSelectionToHide"));const t=this,s=game.settings.get("moulinette","dataExclusions"),i={};if(i.creator={label:game.i18n.format("mtte.clickToHideCreator",{creator:this.selCreator}),callback:()=>{this.selCreator in s||(s[this.selCreator]={}),s[this.selCreator]["*"]=!0,game.settings.set("moulinette","dataExclusions",s).then((()=>{for(const e of game.moulinette.forge)e.instance.clearCache();t.render()}))}},this.selPack>=0){const e=this.packs.find((e=>e.id==this.selPack));e&&(i.pack={label:game.i18n.format("mtte.clickToHidePack",{pack:e.name}),callback:async()=>{this.selCreator in s||(s[this.selCreator]={});const i=(await this.activeModule.instance.getPackList()).find((t=>t.idx==e.id));i&&(i.isRemote?s[this.selCreator][i.packId]=e.name:s[this.selCreator][i.name]=e.name),await game.settings.set("moulinette","dataExclusions",s);for(const e of game.moulinette.forge)e.instance.clearCache();t.render()}})}new Dialog({title:game.i18n.localize("mtte.clickToHideTitle"),content:game.i18n.localize("mtte.clickToHideContent"),buttons:i},{width:600}).render(!0)}}class g{static MAX_HISTORY=100;clearCache(){console.debug("Moulinette Forge Module | Default clearCache() not implemented")}supportsModes(){return console.debug("Moulinette Forge Module | Default supportsMode() not implemented"),!0}supportsPlayersMode(){return console.debug("Moulinette Forge Module | Default playersMode() not implemented"),!1}supportsThumbSizes(){return console.debug("Moulinette Forge Module | Default supportsThumbSizes() not implemented"),!1}supportsWholeWordSearch(){return console.debug("Moulinette Forge Module | Default supportsWholeWordSearch() not implemented"),!1}async onChangeThumbsSize(e){console.debug("Moulinette Forge Module | Default onChangeThumbsSize() does nothing")}async getPackList(){return console.debug("Moulinette Forge Module | Default getPackList() returns empty list"),[]}async getAssetList(e,t,s,i){return console.debug("Moulinette Forge Module | Default getAssetList() returns empty list"),[]}activateListeners(e,t){console.debug("Moulinette Forge Module | Default activeListeners() does nothing")}async onAction(e){console.debug("Moulinette Forge Module | Default onAction() does nothing")}onDragStart(e){console.debug("Moulinette Forge Module | Default onDragStart() does nothing")}async onLeftClickGrid(e){console.debug("Moulinette Forge Module | Default onLeftClickGrid() does nothing")}async onRightClickGrid(e){console.debug("Moulinette Forge Module | Default onRightClickGrid() does nothing")}async getFooter(){return console.debug("Moulinette Forge Module | Default getFooter() returns nothing"),""}async onShortcut(e){console.debug("Moulinette Forge Module | Default onAction() does nothing")}async addToHistory(e,t){const s=game.settings.get("moulinette","favorites");"history"in s||(s.history={icon:"fas fa-history",list:[]});let i=!1;for(let a=0;a<s.history.list.length;a++){const o=s.history.list[a];o.pub==e.publisher&&o.pack==e.name&&o.asset==t.filename&&(s.history.list.splice(a,1),i=!0)}s.history.list.push({pub:e.publisher,pack:e.name,asset:t.filename}),s.history.list.length>g.MAX_HISTORY&&s.history.list.shift(),await game.settings.set("moulinette","favorites",s)}async toggleFavorite(e,t,s=!1){const i=game.settings.get("moulinette","favorites");let a=game.settings.get("moulinette","currentFav");if(s||"history"!=a||(a="default"),!(a in i))return console.warn(`Favorite category ${a} doesn't exist!`),[];let o=!1;for(let s=0;s<i[a].list.length;s++){const n=i[a].list[s];n.pub==e.publisher&&n.pack==e.name&&n.asset==t.filename&&(i[a].list.splice(s,1),o=!0)}s||o||i[a].list.push({pub:e.publisher,pack:e.name,asset:t.filename});const n=[];for(const s in i){if("history"==s)continue;i[s].list.find((s=>s.pub==e.publisher&&s.pack==e.name&&s.asset==t.filename))&&n.push(i[s].icon)}return await game.settings.set("moulinette","favorites",i),n}isFavorite(e,t){const s=[],i=game.settings.get("moulinette","favorites");for(const a in i){if("history"==a)continue;i[a].list.find((s=>s.pub==e.publisher&&s.pack==e.name&&s.asset==t.filename))&&s.push(i[a].icon)}return s}async clearFavorites(){const e=game.settings.get("moulinette","favorites");e[game.settings.get("moulinette","currentFav")].list=[],await game.settings.set("moulinette","favorites",e)}async getAssetURL(e,t){console.debug("Moulinette Forge Module | Default getAssetURL() does nothing")}async indexAssets(){return console.debug("Moulinette Forge Module | Default onIndexAssets() does nothing"),[]}getFilters(){return console.debug("Moulinette Forge Module | Default getFilters() returns nothing"),[]}getBoardDataShortcut(e){return console.debug("Moulinette Forge Module | Default getBoardDataShortcut() not supported"),null}async getBoardDataAssets(e){return console.debug("Moulinette Forge Module | Default getBoardDataAssets() not supported"),null}async getBoardDataAssetName(e){return console.debug("Moulinette Forge Module | Default getBoardDataAssetName() not supported"),null}getBoardDataDataTransfer(e){return console.debug("Moulinette Forge Module | Default getBoardDataDataTransfer() not supported"),{}}async executeBoardDataAsset(e){return console.debug("Moulinette Forge Module | Default executeBoardDataAsset() not supported"),!1}async getBoardDataPreview(e){return console.debug("Moulinette Forge Module | Default getBoardDataPreview() not supported"),""}async stopBoardDataPreview(e){}}class p extends FormApplication{constructor(e,t){super(),this.path=e,this.type=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinette-index",classes:["mtte","help"],title:game.i18n.localize("mtte.moulinetteHelpIndexing"),template:"modules/moulinette-core/templates/help-indexing.hbs",width:700,height:800,resizable:!0,closeOnSubmit:!1,submitOnClose:!1})}async getData(){const e=game.moulinette.applications.MoulinetteFileUtil,t=await FilePicker.browse(e.getSource(),this.path,e.getOptions());let s=[];for(const i of t.dirs){const t=(await FilePicker.browse(e.getSource(),i,e.getOptions())).dirs.map((e=>decodeURIComponent(e.split("/").pop())));s.push({name:decodeURIComponent(i.split("/").pop()),packs:t.join("\n").replaceAll('"',"'"),ok:t.length>0,count:t.length})}const i=game.settings.get("moulinette-core","customPath");let a=!1,o=[];if(i&&i.length>0&&"null"!=i){a=!0;let t=await e.scanFolder(e.getSource(),i,".mtte");if(t.length>0)for(const e of t){const t=e.substring(0,e.lastIndexOf("/")),s=await fetch(e+"?ms="+Date.now(),{cache:"no-store"}).catch((function(e){}));if(200!=s.status){o.push({path:t,configFile:e.split("/").pop(),ok:!1,msg:"File cannot be read"});continue}let i={};try{i=await s.json()}catch(s){o.push({path:t,configFile:e.split("/").pop(),ok:!1,msg:"Not a valid JSON file"});continue}i.publisher&&i.publisher.length>=3&&!i.pack?o.push({path:t,configFile:e.split("/").pop(),ok:!0,msg:`Folder represents the creator '${i.publisher}' (requires subfolders)`}):i.publisher&&i.publisher.length>=3&&i.pack&&i.pack.length>=3?o.push({path:t,configFile:e.split("/").pop(),ok:!0,msg:`Folder represents the creator '${i.publisher}' and pack '${i.pack}'`}):o.push({path:t,configFile:e.split("/").pop(),ok:!1,msg:"Config file is invalid. Make sure to specify 'publisher' and 'pack' correctly"})}}const n=e.getMoulinetteSources().filter((e=>e.type==this.type));return{type:this.type,ok:s.length>0,defPath:this.path,source:{data:"User Data (local)",s3:"S3 Storage",forgevtt:"My Assets Library (The Forge)"}[e.getSource()],creators:s,custom:a,customOK:o.length>0,customPath:i,customFolders:o,others:n.length>0?n:null}}activateListeners(e){super.activateListeners(e),this.html=e,e.find(".refresh").click((e=>{this.render(!0),ui.notifications.info("Help refreshed!")})),e.find("h1").click((e=>{event.preventDefault();const t=event.currentTarget;$(t).next(".section").toggle()}))}}class f extends FormApplication{constructor(e=null){super(),this.section=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinette-help",classes:["mtte","help"],title:game.i18n.localize("mtte.moulinetteHelp"),template:"modules/moulinette-core/templates/help.hbs",width:700,height:800,resizable:!0,closeOnSubmit:!1,submitOnClose:!1})}async getData(){const e=await game.moulinette.applications.Moulinette.getUser(),t=game.settings.get("moulinette-core","s3Bucket");return{user:e,icons:game.moulinette.forge.find((e=>"gameicons"==e.id)),tiles:game.moulinette.forge.find((e=>"tiles"==e.id)),scenes:game.moulinette.forge.find((e=>"scenes"==e.id)),sounds:game.moulinette.forge.find((e=>"sounds"==e.id)),search:game.moulinette.forge.find((e=>"imagesearch"==e.id)),s3bucket:t.length>0&&"null"!=t?t:null,theforge:"undefined"!=typeof ForgeVTT&&ForgeVTT.usingTheForge,latestVersion:game.version.startsWith("11."),hasModules:game.moulinette.forge.length>0,modulesCount:game.moulinette.forge.length}}activateListeners(e){super.activateListeners(e),this.html=e,e.find("a").click(this._onClick.bind(this)),e.find("h1").click((e=>{event.preventDefault();const t=event.currentTarget;$(t).next(".section").toggle()})),navigator.clipboard.writeText("Moulinette rocks!").then((()=>{e.find(".copySuccess").show()})).catch((()=>{e.find(".copyFailed").show()})),this.section&&e.find(`.section[data-id='${this.section}']`).show()}_onClick(e){e.preventDefault();const s=e.currentTarget,i=game.moulinette.modules.find((e=>"forge"==e.id)).class;if(s.classList.contains("patreon"))(new t).render(!0);else if(s.classList.contains("refresh"))this.render(!0),ui.notifications.info("Help refreshed!");else if(s.classList.contains("gameicons"))new i("gameicons").render(!0);else if(s.classList.contains("scenes"))new i("scenes").render(!0);else if(s.classList.contains("sounds"))new i("sounds").render(!0);else if(s.classList.contains("tiles"))new i("tiles").render(!0);else if(s.classList.contains("soundpad"))game.moulinette.forge.find((e=>"sounds"==e.id)).instance.onShortcut("soundpads");else if(s.classList.contains("soundboard"))game.moulinette.forge.find((e=>"sounds"==e.id)).instance.onShortcut("soundboard");else if(s.classList.contains("favorites"))game.moulinette.forge.find((e=>"tiles"==e.id)).instance.onShortcut("favorites");else if(s.classList.contains("faceted-search"))game.moulinette.forge.find((e=>"tiles"==e.id)).instance.onShortcut("search");else if(s.classList.contains("browseMtte")){const e=game.settings.get("moulinette-core","s3Bucket"),t=$(s).data("path")?$(s).data("path"):"moulinette/";if(e.length>0&&"null"!=e){const e=new FilePicker;e.activeSource="s3",e.sources.s3.target=t,e.render(!0)}else if("undefined"!=typeof ForgeVTT&&ForgeVTT.usingTheForge){const e=new FilePicker;e.activeSource="forgevtt",e.sources.forgevtt.target=t,e.render(!0)}else{new FilePicker({current:t}).render(!0)}}else s.classList.contains("checkIndex")&&new p($(s).data("path"),$(s).data("type")).render(!0)}}class b extends FormApplication{constructor(e,t,s){super(),this.extensions=e,this.filters=t,this.callback=s}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"mtteSourcesFilterDialog",classes:["mtte","options"],title:"",template:"modules/moulinette-core/templates/sources-filter.hbs",width:100,height:"auto",closeOnSubmit:!1,submitOnClose:!1})}getData(){const e=[];for(const t of this.extensions)e.push({filter:t,checked:!this.filters||this.filters.includes(t)});return{options:e}}activateListeners(e){const t=this;e.find(".applyFilters").click((s=>{s.preventDefault();const i=[];e.find("input:checkbox:checked").each(((e,t)=>{i.push($(t).val())})),t.callback&&t.callback(0==i.length||i.length==this.extensions.length?null:i),t.close()}))}}class w extends FormApplication{constructor(e,t,s){super(),this.parent=e,this.filters=t,this.curFilters=null,this.extensions=s}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinette-sources",classes:["mtte","sources"],title:game.i18n.localize("mtte.moulinetteSources"),template:"modules/moulinette-core/templates/sources.hbs",width:1e3,height:500,resizable:!0,closeOnSubmit:!1,submitOnClose:!1})}async getData(){let e=[];const t=game.settings.get("moulinette-core","customPath");t&&e.push({auto:!0,type:"global",creator:"*",pack:"*",source:game.moulinette.applications.MoulinetteFileUtil.getSource(),path:t,enabled:!0,custom:!1,immuable:!0});for(const t of this.filters)e.push({auto:!0,type:"default",creator:"*",pack:"*",source:game.moulinette.applications.MoulinetteFileUtil.getSource(),path:`moulinette/${t}/custom`,enabled:!0,custom:!1,immuable:!0});let s=["images","tiles","scenes","sounds"];const i=Array.isArray(game.settings.get("moulinette","sources"))?game.settings.get("moulinette","sources"):[];for(const t of game.moulinette.sources){const s=i.find((e=>e.auto&&e.source==t.source&&e.path==t.path&&e.type==t.type));e.push({auto:!0,type:t.type,creator:s&&s.creator?s.creator:t.publisher,pack:s&&s.pack?s.pack:t.pack,source:t.source,path:t.path,forceRefresh:!!s&&s.forceRefresh,enabled:!s||s.enabled,custom:!!s})}for(const t of i)t.auto||e.push(t);return this.filters.length>0&&(e=e.filter((e=>["global","default"].includes(e.type)||this.filters.includes(e.type))),s=s.filter((e=>this.filters.includes(e)))),this.sources=e,{sources:this.sources,types:s}}activateListeners(e){super.activateListeners(e),this.html=e,e.find(".exports button").click(this._onAction.bind(this)),e.find(".actions a").click(this._onAction.bind(this)),e.find(".actions button").click(this._onAction.bind(this)),e.find(".actions input[type='checkbox']").click((t=>{$(t.currentTarget).is(":checked")?(e.find(".creatorPack.custom").hide(),e.find(".creatorPack.auto").show()):(e.find(".creatorPack.custom").show(),e.find(".creatorPack.auto").hide())})),this.bringToTop()}async _onAction(e){e.preventDefault();const t=Array.isArray(game.settings.get("moulinette","sources"))?game.settings.get("moulinette","sources"):[],s=e.currentTarget;if(s.classList.contains("browse"))new FilePicker({type:"folder",callback:(e,t)=>{this.folder={path:e,source:t.activeSource},ui.notifications.info(`Source ${e} + ${t.activeSource}`),this.html.find(".browse").css("color","green"),this.html.find("#creator").val("My Assets"),this.html.find("#pack").val(e.split("/").pop())}}).browse();else if(s.classList.contains("filter")){const t=this,s=new b(this.extensions,this.curFilters,(function(e){t.curFilters=e}));s.position.left=e.pageX-s.position.width/2,s.position.top=e.pageY-120,s.render(!0)}else if(s.classList.contains("toggle")){const e=s.closest(".source"),i=$(e).data("idx");if(i>=0&&i<this.sources.length){const e=this.sources[i];let s=t.find((t=>t.type==e.type&&t.source==e.source&&t.path==e.path));return s||(s={auto:!0,forceRefresh:!1,type:e.type,source:e.source,path:e.path,enabled:!0},t.push(s)),s.enabled=!s.enabled,await game.settings.set("moulinette","sources",t),this.render()}}else if(s.classList.contains("forceIndex")){const e=s.closest(".source"),i=$(e).data("idx");if(i>=0&&i<this.sources.length){const e=this.sources[i];let s=t.find((t=>t.type==e.type&&t.source==e.source&&t.path==e.path));return s||(s={auto:!0,forceRefresh:!1,type:e.type,source:e.source,path:e.path,enabled:!0},t.push(s)),s.forceRefresh=!s.forceRefresh,await game.settings.set("moulinette","sources",t),this.render()}}else if(s.classList.contains("edit")){const e=s.closest(".source"),t=$(e).data("idx");if(t>=0&&t<this.sources.length){const e=this.sources[t];this.html.find("#idxEdit").val(t),this.curFilters=e.filters,"*"==e.creator?(this.html.find("#autoEdit").prop("checked",!0),this.html.find(".creatorPack.auto").show(),this.html.find(".creatorPack.custom").hide()):(this.html.find("#autoEdit").prop("checked",!1),this.html.find(".creatorPack.auto").hide(),this.html.find(".creatorPack.custom").show()),this.html.find(".update").show(),this.html.find(".add").hide(),this.html.find("#creatorEdit").val(e.creator),this.html.find("#packEdit").val(e.pack)}}else if(s.classList.contains("reset")||s.classList.contains("delete")){const e=s.closest(".source"),i=$(e).data("idx");if(i>=0&&i<this.sources.length){const e=this.sources[i],a=t.find((t=>t.type==e.type&&t.source==e.source&&t.path==e.path)),o=this;a&&Dialog.confirm({title:game.i18n.localize(s.classList.contains("reset")?"mtte.resetSource":"mtte.deleteSource"),content:game.i18n.localize(s.classList.contains("reset")?"mtte.resetSourceContent":"mtte.deleteSourceContent"),yes:async function(){return await game.settings.set("moulinette","sources",t.filter((e=>e!==a))),o.render()},no:()=>{}})}}else{if(s.classList.contains("add")){const e=this.html.find("#auto").is(":checked"),s=this.html.find("select[name=type] option").filter(":selected").val(),i=this.html.find("#creator").val(),a=this.html.find("#pack").val(),o=this.folder;if(!s||s.length<3)return ui.notifications.error("Please select a valid source type (drop-down list)!");if(!o)return ui.notifications.error("Please browse and pick a valid folder!");if(!e&&(!i||i.length<1||i.length>120))return ui.notifications.error("Please enter a valid text (max 120 chars) as creator!");if(!e&&(!a||a.length<1||a.length>120))return ui.notifications.error("Please enter a valid text (max 120 chars) as pack!");return this.sources.find((e=>e.type==s&&e.source==o.source&&e.path==o.path))?void ui.notifications.error("This path already exist!"):(t.push({auto:!1,forceRefresh:!1,type:s,creator:e?"*":i,pack:e?"*":a,source:o.source,filters:this.curFilters&&this.curFilters.length>0?this.curFilters:null,path:o.path,enabled:!0}),this.folder=null,this.curFilters=null,this.html.find(".browse").css("color","inherit"),await game.settings.set("moulinette","sources",t),this.render())}if(s.classList.contains("cancel"))this.html.find(".creatorPack.custom").show(),this.html.find(".creatorPack.auto").hide(),this.html.find("#auto").prop("checked",!1),this.html.find(".update").hide(),this.html.find(".add").show(),this.folder=null,this.curFilters=null;else{if(s.classList.contains("update")){const e=this.html.find("#autoEdit").is(":checked"),s=this.html.find("#idxEdit").val(),i=this.html.find("#creatorEdit").val(),a=this.html.find("#packEdit").val();if(s<0||s>=this.sources.length)return;if(!e&&(!i||i.length<1||i.length>120))return ui.notifications.error("Please enter a valid text (max 120 chars) as creator!");if(!e&&(!a||a.length<1||a.length>120))return ui.notifications.error("Please enter a valid text (max 120 chars) as pack!");const o=this.sources[s];let n=t.find((e=>e.type==o.type&&e.source==o.source&&e.path==o.path));return n||(n={auto:o.auto,type:o.type,source:o.source,path:o.path,enabled:!0},t.push(n)),n.creator=e?"*":i,n.pack=e?"*":a,n.filters=this.curFilters,await game.settings.set("moulinette","sources",t),this.folder=null,this.curFilters=null,this.render()}if(s.classList.contains("export")){const e=`moulinette-${game.world.id}-sources.json`,t=Array.isArray(game.settings.get("moulinette","sources"))?game.settings.get("moulinette","sources"):[];saveDataToFile(JSON.stringify(t,null,2),"text/json",e)}else if(s.classList.contains("import")){const e=this;new Dialog({title:"Import Data: Moulinette Sources",content:await renderTemplate("templates/apps/import-data.html",{hint1:game.i18n.format("DOCUMENT.ImportDataHint1",{document:"sources"}),hint2:game.i18n.format("DOCUMENT.ImportDataHint2",{name:"this config"})}),buttons:{import:{icon:'<i class="fas fa-file-import"></i>',label:"Import",callback:t=>{const s=t.find("form")[0];if(!s.data.files.length)return ui.notifications.error("You did not upload a data file!");readTextFromFile(s.data.files[0]).then((t=>{game.settings.set("moulinette","sources",JSON.parse(t)).then((t=>e.render(!0)))}))}},no:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("mtte.cancel")}},default:"import"},{width:400}).render(!0)}else if(s.classList.contains("index")){ui.notifications.info(game.i18n.localize("mtte.indexingInProgress")),game.moulinette.applications.Moulinette.inprogress(this.html.find(".index"));for(const e of this.filters)await game.moulinette.applications.MoulinetteFileUtil.updateIndex(this.parent,e,`moulinette/${e}/custom`,this.extensions,!1);game.moulinette.cache.clear(),this.parent&&(this.parent.clearCache(),this.close())}else if(s.classList.contains("clearIndex")){const e=this;Dialog.confirm({title:game.i18n.localize("mtte.clearIndex"),content:game.i18n.localize("mtte.clearIndexConfirmation"),yes:async function(){for(const t of e.filters)await game.moulinette.applications.MoulinetteFileUtil.uploadFile(new File([JSON.stringify({})],"index-mtte.json",{type:"application/json",lastModified:new Date}),"index-mtte.json",`moulinette/${t}/custom`,!0);game.moulinette.cache.clear(),e.parent&&(e.parent.clearCache(),e.close())},no:()=>{}})}}}}close(){(new(0,game.moulinette.modules.find((e=>"forge"==e.id)).class)).render(!0),super.close()}}class v extends FormApplication{constructor(e,t,s,i,a){super(),this.pack=e,this.url=t,this.asset=i,this.size=s,this.searchIdx=a||null}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinette-availableresult",classes:["mtte","forge","searchresult"],title:game.i18n.localize("mtte.availableresult"),template:"modules/moulinette-core/templates/availableresult.hbs",width:620,height:"auto",closeOnSubmit:!0,submitOnClose:!1})}async getData(){const e=new game.moulinette.applications.MoulinetteClient,t=await e.get(`/api/marketplace/${this.pack.id}/${this.searchIdx}`);200==t.status&&(this.pack.creator=t.data.publisher,this.pack.name=t.data.pack);let s="",i=null;if(this.asset.data&&"snd"==this.asset.data.type){const e=Math.floor(this.asset.data.duration/3600),t=Math.floor((this.asset.data.duration-3600*e)/60),a=this.asset.data.duration%60;s=(e>0?`${e}:${t.toString().padStart(2,"0")}`:t.toString())+":"+a.toString().padStart(2,"0"),i=`${this.pack.baseUrl}/${this.asset.data.path.slice(0,-4)}_preview.ogg`}const a=t.data.tiers.filter((e=>"patreon"==e.source)),o=t.data.tiers.filter((e=>"discord"==e.source));return{imageSize:this.size,creatorUrl:200==t.status?t.data.publisherUrl:null,mouliplaceCreatorUrl:200==t.status?t.data.mouliplaceCreatorUrl:null,mouliplaceUrl:200==t.status?t.data.mouliplaceUrl:null,moulinetteUrl:"https://assets.moulinette.cloud/marketplace/creators",tiers:a,hasTiers:a.length>0,roles:o,hasRoles:o.length>0,vanity:t.data.vanity,asset:this.asset,isSound:this.asset.data&&"snd"==this.asset.data.type,soundDuration:s,previewSoundURL:i,pack:this.pack,url:this.url,assetName:this.url.split("/").pop().replace("_thumb",""),assetPath:this.url.substring(0,this.url.lastIndexOf("/"))}}activateListeners(e){e.find(".previewSound").click((t=>{t.preventDefault();const s=e.find("#availResultPreview")[0];return s.paused?s.play():s.pause(),!1})),this.bringToTop()}}class y extends FormApplication{static MAX_ASSETS=100;constructor(e,t,s){super(),this.assetInc=0,this.assetsData={},this.assetsType=t,this.assetsSize=s,this.searchTerms=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinette-available",classes:["mtte","forge","available"],title:game.i18n.localize("mtte.availableAssets"),template:"modules/moulinette-core/templates/available.hbs",width:850,height:800,closeOnSubmit:!0,submitOnClose:!1,resizable:!0})}async getData(){this.assets=[],this.assetsData=await game.moulinette.applications.MoulinetteFileUtil.getAvailableMatchesMoulinetteCloud(this.searchTerms,this.assetsType,!1);const e=this.assetsData.id;for(let t=0;t<this.assetsData.results.length;t++){const s=this.assetsData.results[t],i=this.assetsData.packs[s.pack],a=s.data?s.data.path:s.path,o=`${i.baseUrl}/${a}`,n=`${a.split("/").pop().replace("_thumb","")} from ${i.creator} (${i.name})`;if(s.data&&"snd"==s.data.type){const a=game.moulinette.applications.Moulinette.prettyText(s.data.title&&s.data.title.length>0?s.data.title:s.data.path.split("/").pop()),o=a.length<=40?a:a.substring(0,40)+"...",l=Math.floor(s.data.duration/3600),r=Math.floor((s.data.duration-3600*l)/60),c=s.data.duration%60,u=(l>0?`${l}:${r.toString().padStart(2,"0")}`:r.toString())+":"+c.toString().padStart(2,"0"),d=`${i.baseUrl}/${s.data.path.slice(0,-4)}_preview.ogg`;let h=`<div class="sound" data-idx="${t}" data-sidx="${e}"><div class="audio" title="${n}">${o}</div><div class="background"><i class="fas fa-music"></i></div><div class="duration"><i class="far fa-hourglass"></i> ${u}</div><div class="sound-controls">`+(s.data.preview?`<div class="ctrl sound-play" data-url="${d}"><a data-action="sound-play" title="${game.i18n.localize("mtte.previewSound")}"><i class="fas fa-play"></i></a></div>`:"")+"</div></div>";this.assets.push(h)}else this.assets.push(`<div class="tileres" title="${n}" data-idx="${t}" data-sidx="${e}"><img width="${this.assetsSize}" height="${this.assetsSize}" src="${o}"/></div>`)}return this.assets.sort(((e,t)=>.5-Math.random())),{assets:this.assets.slice(0,y.MAX_ASSETS)}}activateListeners(e){this.html=e,this.html.find(".tileres").click(this._onShowTile.bind(this)),this.html.find(".sound").click(this._onShowTile.bind(this)),this.bringToTop(),this.html.find(".list").on("scroll",this._onScroll.bind(this));const t=this;this.html.find(".sound-play").click((s=>{s.preventDefault();const i=e.find("#availablePreview")[0],a=$(s.currentTarget).data("url");return a==t.previewUrl?i.paused?i.play():i.pause():(t.previewUrl=a,i.src=a,i.play()),!1}))}_reEnableListeners(){this.html.find("*").off(),this.activateListeners(this.html),this._activateCoreListeners(this.html)}_onShowTile(e){e.preventDefault();const t=e.currentTarget,s=t.dataset.idx,i=t.dataset.sidx;if(s>=0&&s<this.assetsData.results.length){const e=this.assetsData.results[s],t=this.assetsData.packs[e.pack],a=e.data?`${t.baseUrl}/${e.data.path}`:`${t.baseUrl}/${e.path}`;this.html.find("#availablePreview")[0].pause(),new v(t,a,this.assetsSize,e,i).render(!0)}}async _onScroll(e){if(this.ignoreScroll)return;const t=$(e.currentTarget).prop("scrollHeight")-$(e.currentTarget).scrollTop(),s=$(e.currentTarget).height();this.assets&&t-20<s&&(this.ignoreScroll=!0,this.assetInc*y.MAX_ASSETS<this.assets.length&&(this.assetInc++,this.html.find(".list").append(this.assets.slice(this.assetInc*y.MAX_ASSETS,(this.assetInc+1)*y.MAX_ASSETS)),this._reEnableListeners()),this.ignoreScroll=!1)}}class k extends Application{constructor(e){super({title:e})}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinette-progress",classes:["mtte","progress","preview"],title:game.i18n.localize("mtte.progress"),template:"modules/moulinette-core/templates/progress.hbs",width:500,height:90})}activateListeners(e){super.activateListeners(e),this.html=e}setProgress(e,t){if(100==(e=Math.round(e))&&setTimeout((()=>this.close()),1e3),this.html){if(e>=0&&e<=100){const t=this.html.find(".progress");t.css("width",`${e}%`),t.text(`${e}%`)}t&&this.html.find(".description").text(t)}}}class M{static searchUI(e,t={}){const s=game.moulinette.modules.find((e=>"forge"==e.id)).class;if(!s)return console.error("Moulinette API | You need to specify a valid (and enabled moulinette module) when calling searchUI. Try 'tiles' or 'scenes'");new s(e,t).render(!0)}static async assetPicker(e,t={}){const s=game.moulinette.forge.find((e=>"tiles"==e.id));if(!s)return console.error("Moulinette API | Moulinette Tiles is required. Please install and enable it!");const i=new r(s,{type:"image",search:t,callbackSelect:t=>t?(this.field&&(this.field.value=t,this.field.dispatchEvent(new Event("change"))),e&&e(t,this),i.close()):ui.notifications.error("You must select an asset to proceed."),callbackDefault:()=>{i.close();const t=new FilePicker({forceDefault:!0,type:"image",callback:s=>(e&&e(s,this),t.close())});return t.render(!0)}});i.render(!0)}static getAssetURL(e,t,s){const i=game.moulinette.forge.find((t=>t.id==e));return i?i.instance.getAssetURL(t,s):null}}class S{static SUPPORTED_MTYPES=["Sound","Tile"];static SUPPORTED_TYPES=["Macro","RollTable","Scene","Actor","Item","JournalEntry","PlaylistSound"];static ICONS={Scene:"fas fa-map",JournalEntry:"fas fa-book-open",Macro:"fas fa-code",PlaylistSound:"fas fa-music",RollTable:"fas fa-th-list",Actor:"fas fa-user",Item:"fas fa-suitcase"};static MODULES={Sound:"sounds",Tile:"tiles"};static async createShortcut(e){if("mtte"==e.source){if(S.MODULES[e.type]){const t=game.moulinette.forge.find((t=>t.id==S.MODULES[e.type])),s=t.instance.getBoardDataShortcut(e);if(s){const i=await t.instance.getBoardDataAssets(e);if(i)return s.assets=i,s}}return null}if(S.SUPPORTED_TYPES.includes(e.type)){const t=await fromUuid(e.uuid);if(t){let s={type:e.type,name:t.name,icon:t.img||S.ICONS[e.type],assets:[{uuid:e.uuid}]};return t.img||(s.faIcon=!0),s}}return console.log(e),null}static async executeShortcut(e){if(!e.assets||!Array.isArray(e.assets))return;const t=e.assets[Math.floor(Math.random()*e.assets.length)];if(S.MODULES[e.type]){const s=game.moulinette.forge.find((t=>t.id==S.MODULES[e.type]));await s.instance.executeBoardDataAsset(t)||ui.notifications.error(game.i18n.localize("mtte.errorBoardShortcutNotExecutable"))}else switch(e.type){case"Macro":const e=await fromUuid(t.uuid);console.log(e),e&&e.execute();break;case"RollTable":const s=await fromUuid(t.uuid);s&&s.draw({displayChat:!0});break;case"Scene":const i=await fromUuid(t.uuid);i&&i.view();break;case"Actor":case"Item":case"JournalEntry":const a=await fromUuid(t.uuid);a&&a.sheet.render(!0);break;case"PlaylistSound":const o=await fromUuid(t.uuid);o&&(o.playing?await o.parent.stopSound(o):await o.parent.playSound(o));break;default:return ui.notifications.error(game.i18n.localize("mtte.errorBoardShortcutNotExecutable"))}}static async getAssets(e){if(!e.assets||!Array.isArray(e.assets))return null;const t=[];for(const s of e.assets)switch(e.type){case"Sound":case"Tile":const i=game.moulinette.forge.find((t=>t.id==S.MODULES[e.type])),a=await i.instance.getBoardDataAssetName(s);t.push({name:a||"-- invalid --"});break;case"Macro":case"RollTable":case"Scene":case"Actor":case"Item":case"JournalEntry":case"PlaylistSound":const o=await fromUuid(s.uuid);t.push({name:o?o.name:"-- invalid --"})}return t}static getDataTransfer(e){if(delete game.moulinette.board.selected,!e.assets||!Array.isArray(e.assets))return;const t=e.assets[Math.floor(Math.random()*e.assets.length)];if(t.pack){game.moulinette.board.selected=e;const s=game.moulinette.forge.find((t=>t.id==S.MODULES[e.type]));if(s)return s.instance.getBoardDataDataTransfer(t)}else if(S.SUPPORTED_TYPES.includes(e.type))return{uuid:t.uuid,type:e.type};return delete game.moulinette.board.selected,{}}static getRandomAsset(){return game.moulinette.board.selected?S.getDataTransfer(game.moulinette.board.selected):null}static async generatePreview(e){if(!e)return"";let t="";if(e.assets){if(S.SUPPORTED_MTYPES.includes(e.type)){const s=game.moulinette.forge.find((t=>t.id==S.MODULES[e.type]));s&&(t+=await s.instance.getBoardDataPreview(e))}else if(S.SUPPORTED_TYPES.includes(e.type)){if(t=`<h3><i class="${S.ICONS[e.type]} fa-lg"></i> ${e.name}</h3>`,e.assets.length>1)t+=game.i18n.format("mtte.boardAssetsCount",{count:e.assets.length,type:e.type});else if(1==e.assets.length){const s=await fromUuid(e.assets[0].uuid);if(s)switch(e.type){case"Macro":t+=game.i18n.format("mtte.boardMacro",{type:s.type});break;case"JournalEntry":t+=game.i18n.format("mtte.boardJournal",{count:s.pages.size});break;case"Scene":s.thumbnail&&(t+=`<img src="${s.thumbnail}"/>`);break;default:t+=game.i18n.format("mtte.boardOther",{type:e.type})}}t+="<hr>"+game.i18n.localize("mtte.boardInstructions"+e.type)+game.i18n.localize("mtte.boardInstructionsCommon")}}else t=`<h3><i class="fas fa-folder-open fa-lg"></i> ${e.name}</h3>`,t+="<hr>"+game.i18n.localize("mtte.boardInstructionsFolder")+game.i18n.localize("mtte.boardInstructionsCommon");return t}static stopPreview(e){if(e&&e.assets)if(S.SUPPORTED_MTYPES.includes(e.type)){const t=game.moulinette.forge.find((t=>t.id==S.MODULES[e.type]));t&&t.instance.stopBoardDataPreview(e)}else if(S.SUPPORTED_TYPES.includes(e.type))return}static countChildren(e){let t=1;if(e.nav)for(const s of e.nav)t+=S.countChildren(s);return t}}class C extends FormApplication{constructor(e,t,s){super(),this.boardUI=e,this.board=this.boardUI.getBoardData(),this.boardGroupData=this.boardUI.getGroupData(this.board,t),s&&s>0&&s<=this.boardGroupData.nav.length?(this.navItem=this.boardGroupData.nav[s-1],this.isNew=!1,this.idx=s):(this.navItem={},this.boardGroupData.nav.push(this.navItem),this.isNew=!0)}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinette-board-edit",classes:["mtte","boardedit"],title:game.i18n.localize("mtte.boardGroup"),template:"modules/moulinette-core/templates/board-edit.hbs",width:500,height:"auto",closeOnSubmit:!0,submitOnClose:!1})}async getData(){return{data:this.navItem,isNew:this.isNew,assets:await S.getAssets(this.navItem)}}async close(e={}){this.boardUI&&this.boardUI.refresh(),super.close(e)}async _onClick(e){e.preventDefault();const t=e.currentTarget;if(t.classList.contains("cancel"))this.close();else if(t.classList.contains("browse")){const e=this.html.find("input.icon2").val();new FilePicker({callback:this._onPathChosen.bind(this),current:e||"moulinette/images/",type:"image"}).render(!0)}else if(t.classList.contains("browseSound"))new FilePicker({callback:this._onAudioChosen.bind(this),type:"audio"}).render(!0);else if(t.classList.contains("browseGameIcon")){const e=game.moulinette.applications.MoulinetteGameIconsPicker;if(!e)return ui.notifications.error(game.i18n.localize("mtte.errorGameIconModule"));if(!game.permissions.FILES_UPLOAD.includes(game.user.role))return ui.notifications.error(game.i18n.localize("mtte.filepickerCanNotUpload"));e.browse("",(e=>{this._onPathChosen(e)}))}else if(t.classList.contains("deleteShortcut")){if(!await Dialog.confirm({title:game.i18n.localize("mtte.deleteBoardGroup"),content:game.i18n.format("mtte.deleteBoardGroupContent",{name:this.navItem.name,count:S.countChildren(this.navItem)})}))return;this.idx>0&&this.idx<=this.boardGroupData.nav.length?(this.boardGroupData.nav.splice(this.idx-1,1),await this.boardUI.storeBoardData(this.board),this.close()):console.error("Moulinette Board | Something went wrong with deletion",this.idx,this.board)}else if(t.classList.contains("save")){if(!this.navItem.name)return ui.notifications.error(game.i18n.localize("mtte.errorBoardNoName"));this.boardUI&&await this.boardUI.storeBoardData(this.board),this.close()}}_onPathChosen(e){this.html.find("input.icon2").val(e),this.html.find(".icon").val(""),this.navItem.icon=e,this.navItem.faIcon=!1,this._updatePreview()}_updatePreview(){this.boardUI&&this.boardUI.refresh(this.board)}activateListeners(e){const t=this;this.html=e,IconPicker.Init({jsonUrl:"/modules/moulinette-core/iconpicker/iconpicker.json",searchPlaceholder:game.i18n.localize("mtte.searchIcon"),showAllButton:game.i18n.localize("mtte.showAll"),cancelButton:game.i18n.localize("mtte.cancel"),noResultsFound:game.i18n.localize("mtte.noResultsFound")}),IconPicker.Run("#GetIconPickerEdit",(function(){e.find(".icon2").val(""),t.navItem.icon=t.html.find("input.icon").val(),t.navItem.faIcon=t.navItem.icon.length>0,t._updatePreview()})),e.find("button").click(this._onClick.bind(this)),e.find("input.shortText").on("input",(function(e){const s=$(e.currentTarget).val();t.navItem.name=s,t._updatePreview()})),e.find("#IconInputEdit").change((s=>{e.find(".icon2").val("");const i=$(s.currentTarget).val();t.navItem.icon=i,t.navItem.faIcon=i.length>0,t._updatePreview()})),e.find(".icon2").change((s=>{e.find(".icon").val("");const i=$(s.currentTarget).val();t.navItem.icon=i,t.navItem.faIcon=!1,t._updatePreview()})),e.find("input.shortText").focus().val($("input.shortText").val()),e.find(".delete").click((e=>{if(t.navItem.assets.length<=1)return ui.notifications.error(game.i18n.localize("mtte.errorBoardDeleteLastAsset"));const s=$(e.currentTarget).data("idx");t.navItem.assets.splice(s,1),t.render(!0),t._updatePreview()})),e.find(".boarddrop").on("dragenter",(function(e){e.preventDefault(),$(e.currentTarget).addClass("target")})).on("dragleave",(function(e){e.preventDefault(),$(e.currentTarget).removeClass("target")})).on("drop",(function(e){e.preventDefault();let s=null;try{s=JSON.parse(e.originalEvent.dataTransfer.getData("text/plain"))}catch(e){return{}}s&&S.createShortcut(s).then((e=>{if(e){if(e.type!=t.navItem.type)return ui.notifications.error(game.i18n.localize("mtte.errorNotSameType"));t.navItem.assets.push(...e.assets),t.render(!0),t._updatePreview()}}))}))}}class T extends FormApplication{constructor(){super()}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"moulinette-board-help",classes:["mtte","boardedit"],title:"Moulinette Board",template:"modules/moulinette-core/templates/board-help.hbs",width:500,height:"auto",closeOnSubmit:!0,submitOnClose:!1})}}class D{static getBoardData(){const e=duplicate(game.settings.get("moulinette","board"));return e.nav||(e.nav=[]),e}static async storeBoardData(e){e&&e.nav&&await game.settings.set("moulinette","board",e)}static getGroupData(e,t){if(!e||!t||t<1)return null;if(e.nav||(e.nav=[]),1==t)return e;const s=e.nav.find((e=>e.selected));return s?D.getGroupData(s,t-1):null}static generateNavigation(e,t=!1){const s=t?'draggable="true"':"";return e.map(((e,t)=>{const i=e.selected?" selected":"";if(e.icon&&e.faIcon)return`<i class="lvl${i} ${e.icon}" data-idx="${t+1}" ${s}></i>`;if(e.icon)return`<div class="lvl${i}" data-idx="${t+1}" ${s}><img src="${e.icon}" /></div>`;{let a="";return e.name.length>10?a="longtext":e.name.length>5&&(a="mediumtext"),`<div class="lvl${i}" data-idx="${t+1}" ${s}><span class="${a}">${e.name}</span></div>`}})).join("")}static toggle(){$("#mtteboard").toggle(),$("#mtteboard").is(":visible")&&D.refresh()}static refresh(e){0==$("#mtteboard").length&&($("body").append('<div id="mtteboard"><img class="logo" src="/modules/moulinette-core/img/moulinette.png"/><div class="top" data-lvl="1"></div><div class="nav"></div><div id="boardpreview"/></div>'),$("#mtteboard .logo").click((e=>{(new T).render(!0)})));const t='<div class="empty" data-idx="0"></div>',s=e||D.getBoardData();let i=D.getGroupData(s,1),a=t+D.generateNavigation(i.nav,!e);e||(a+='<i class="lvl action fa-solid fa-circle-plus"></i>');let o="";if(i=D.getGroupData(s,2),i){let a=i.nav.find((e=>e.selected));if(o+=`<div class="list ${a?"hasSel":""}" data-lvl="2">`+t+`${D.generateNavigation(i.nav,!e)}`+(e?"</div>":'<i class="lvl action fa-solid fa-circle-plus"></i></div>'),i=D.getGroupData(s,3),i&&(a=i.nav.find((e=>e.selected)),i&&(o+=`<div class="list ${a?"hasSel":""}" data-lvl="3">`+t+`${D.generateNavigation(i.nav,!e)}`+(e?"</div>":'<i class="lvl action fa-solid fa-circle-plus"></i></div>')),i=D.getGroupData(s,4),i)){!i.nav||i.nav.length;o+='<div class="list" data-lvl="4">'+t+`${D.generateNavigation(i.nav,!e)}`+(e?"</div>":'<i class="lvl action fa-solid fa-circle-plus"></i></div>')}}$("#mtteboard .top").html(a),$("#mtteboard .nav").html(o),e||($("#mtteboard .action").click(D._onAddBoardGroup),$("#mtteboard .lvl").mouseup(D._onClickBoardGroup).on("mouseenter",(e=>{const t=$(e.currentTarget),i=t.data("idx"),a=t.closest("[data-lvl]").data("lvl"),o=D.getGroupData(s,a);o&&i>0&&i<=o.nav.length&&S.generatePreview(o.nav[i-1]).then((e=>{$("#boardpreview").html(e).css({top:t.offset().top,left:t.offset().left+t.width()+20,visibility:"visible",opacity:1})}))})).on("mouseleave",(e=>{const t=$(e.currentTarget),i=t.data("idx"),a=t.closest("[data-lvl]").data("lvl"),o=D.getGroupData(s,a);$("#boardpreview").css({visibility:"hidden",opacity:0}),o&&i>0&&i<=o.nav.length&&S.stopPreview(o.nav[i-1])})),$("#mtteboard .top > *:not(.action), #mtteboard .list > *:not(.action)").on("dragstart",(function(e){e.stopPropagation(),$("#boardpreview").css({visibility:"hidden",opacity:0});let t={board:{lvl:$(e.currentTarget).closest("[data-lvl]").data("lvl"),idx:$(e.currentTarget).data("idx")}};const i=D.getGroupData(s,t.board.lvl);i&&(t=foundry.utils.mergeObject(t,S.getDataTransfer(i.nav[t.board.idx-1]))),console.log(t),e.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(t))})).on("dragend",(function(e){e.preventDefault(),$("#mtteboard .empty").removeClass("expand")})).on("dragenter",(function(e){e.preventDefault(),$("#mtteboard .empty").addClass("expand"),$(e.currentTarget).addClass("dropzone")})).on("dragleave",(function(e){e.preventDefault(),$(e.currentTarget).removeClass("dropzone")})).on("dragover",(function(e){e.preventDefault()})).on("drop",(function(e){e.preventDefault(),$(e.currentTarget).removeClass("dropzone");const t={lvl:$(e.currentTarget).closest("[data-lvl]").data("lvl"),idx:$(e.currentTarget).data("idx")};let i=null;try{i=JSON.parse(e.originalEvent.dataTransfer.getData("text/plain"))}catch(e){return{}}if(i)if(i.board){const e=i.board;if(e.lvl==t.lvl&&e.idx==t.idx)return;const s=D.getBoardData(),a=D.getGroupData(s,e.lvl),o=D.getGroupData(s,t.lvl);if(a&&o){const i=a.nav[e.idx-1];if(e.lvl!=t.lvl&&!i.assets)return ui.notifications.error(game.i18n.localize("mtte.errorBoardMove"));const n=a.nav.splice(e.idx-1,1)[0],l=e.lvl==t.lvl&&e.idx<t.idx?t.idx-1:t.idx;o.nav.splice(l,0,n),D.storeBoardData(s).then((()=>D.refresh()))}}else S.createShortcut(i).then((e=>{if(!e)return console.warn("Moulinette Board | No support for : ",i),ui.notifications.error(game.i18n.localize("mtte.errorUnsupportedType"));{const i=D.getGroupData(s,t.lvl);i&&(i.nav.splice(t.idx,0,e),D.storeBoardData(s).then((()=>D.refresh())))}}))})))}static _onAddBoardGroup(e){e.preventDefault();const t=$(e.currentTarget).closest("[data-lvl]").data("lvl");t&&(4==t?ui.notifications.info(game.i18n.localize("mtte.boardMaxLevelReached")):new C(D,t).render(!0))}static _onClickBoardGroup(e){const t=$(e.currentTarget).data("idx"),s=$(e.currentTarget).closest("[data-lvl]").data("lvl");if(t&&s)if(1==e.which){const e=D.getBoardData(),i=D.getGroupData(e,s);t>0&&t<=i.nav.length&&(i.nav[t-1].type?S.executeShortcut(i.nav[t-1]):(i.nav.forEach((e=>delete e.selected)),i.nav[t-1].selected=!0,D.storeBoardData(e).then((()=>D.refresh()))))}else 3==e.which&&s&&new C(D,s,t).render(!0)}}Hooks.once("init",(async function(){console.log("Moulinette Core| Init"),game.settings.register("moulinette","userId",{scope:"world",config:!1,type:String,default:"anonymous"}),game.settings.register("moulinette","currentTab",{scope:"client",config:!1,type:String,default:"scenes"}),game.settings.register("moulinette","displayMode",{scope:"client",config:!1,type:String,default:"list"}),game.settings.register("moulinette","winPosForge",{scope:"client",config:!1,type:Object,default:null}),game.settings.register("moulinette","favorites",{scope:"world",config:!1,type:Object,default:{default:{icon:"fas fa-heart",list:[]}}}),game.settings.register("moulinette","currentFav",{scope:"world",config:!1,type:String,default:"history"}),game.settings.register("moulinette","sources",{scope:"world",config:!1,type:Object,default:[]}),game.settings.register("moulinette","wholeWordSearch",{scope:"client",config:!1,type:Boolean,default:!1}),game.settings.register("moulinette","moduleFilters",{scope:"client",config:!1,type:Object,default:{}}),game.settings.register("moulinette","dataExclusions",{scope:"world",config:!1,type:Object,default:{}}),game.settings.register("moulinette","board",{scope:"world",config:!1,type:Object,default:{}}),game.settings.register("moulinette-core","enableMoulinetteCloud",{name:game.i18n.localize("mtte.configEnableMoulinetteCloud"),hint:game.i18n.localize("mtte.configEnableMoulinetteCloudHint"),scope:"world",config:!0,default:!0,type:Boolean,onChange:()=>game.moulinette.user={}}),game.settings.register("moulinette-core","showCaseContent",{name:game.i18n.localize("mtte.configShowCase"),hint:game.i18n.localize("mtte.configShowCaseHint"),scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("moulinette-core","showCloudContent",{name:game.i18n.localize("mtte.configShowCloudContent"),hint:game.i18n.localize("mtte.configShowCloudContentHint"),scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("moulinette-core","dropdownMode",{name:game.i18n.localize("mtte.configDropdownMode"),hint:game.i18n.localize("mtte.configDropdownModeHint"),scope:"world",config:!0,default:null,choices:{none:game.i18n.localize("mtte.dropdownDefault"),auto:game.i18n.localize("mtte.dropdownAuto")},type:String}),game.settings.register("moulinette-core","cloudColor",{name:game.i18n.localize("mtte.configCloudColor"),hint:game.i18n.localize("mtte.configCloudColorHint"),scope:"world",config:!0,default:"def",choices:{none:game.i18n.localize("mtte.cloudColorNone"),def:game.i18n.localize("mtte.cloudColorDefault"),contrast:game.i18n.localize("mtte.cloudColorContrast")},type:String}),game.settings.register("moulinette-core","browseMode",{name:game.i18n.localize("mtte.configBrowseMode"),hint:game.i18n.localize("mtte.configBrowseModeHint"),scope:"world",config:!0,default:"",choices:{byPack:game.i18n.localize("mtte.browseByPack"),byPub:game.i18n.localize("mtte.browseByPublisher")},type:String}),game.settings.register("moulinette-core","subControls",{name:game.i18n.localize("mtte.configSubControls"),hint:game.i18n.localize("mtte.configSubControlsHint"),scope:"world",config:!0,default:!0,type:Boolean}),game.settings.register("moulinette-core","filepicker",{name:game.i18n.localize("mtte.configFilepicker"),hint:game.i18n.localize("mtte.configFilepickerHint"),scope:"world",config:!0,default:!1,type:Boolean,onChange:()=>window.location.reload()}),game.settings.register("moulinette-core","uiMode",{name:game.i18n.localize("mtte.configUIMode"),hint:game.i18n.localize("mtte.configUIModeHint"),scope:"world",config:!0,default:"default",choices:{compact:game.i18n.localize("mtte.uiModeCompact"),default:game.i18n.localize("mtte.uiModeDefault")},type:String}),game.settings.register("moulinette-core","debugScanAssets",{name:game.i18n.localize("mtte.configDebugScanAssets"),hint:game.i18n.localize("mtte.configDebugScanAssetsHint"),scope:"world",config:!0,default:!1,type:Boolean}),game.settings.register("moulinette-core","s3Bucket",{name:game.i18n.localize("mtte.configS3"),hint:game.i18n.localize("mtte.configS3Hint"),scope:"world",config:!0,default:"",type:String}),game.settings.register("moulinette-core","customPath",{name:game.i18n.localize("mtte.configCustomPath"),hint:game.i18n.localize("mtte.configCustomPathHint"),scope:"world",config:!0,default:"",type:String}),game.keybindings.register("moulinette-core","favoriteKey",{name:game.i18n.localize("mtte.configFavoriteKey"),hint:game.i18n.localize("mtte.configFavoriteKeyHint"),editable:[{key:"KeyM",modifiers:["Control"]}],onDown:()=>{game.moulinette.applications.MoulinetteTilesFavorites?(new game.moulinette.applications.MoulinetteTilesFavorites).render(!0):console.warn("Moulinette Tiles not enabled (or not up-to-date?)")},onUp:()=>{},restricted:!0,reservedModifiers:[],precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register("moulinette-core","layerKey",{name:game.i18n.localize("mtte.configLayerKey"),hint:game.i18n.localize("mtte.configLayerKeyHint"),editable:[],onDown:()=>{canvas.moulinette.activate()},onUp:()=>{},restricted:!0,reservedModifiers:[],precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.keybindings.register("moulinette-core","board",{name:game.i18n.localize("mtte.configBoard"),hint:game.i18n.localize("mtte.configBoardHint"),editable:[],onDown:()=>{game.moulinette.applications.Moulinette.getUser().then((()=>{t.hasEarlyAccess()&&D.toggle()}))},onUp:()=>{},restricted:!0,reservedModifiers:[],precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL}),game.moulinette={user:{hasEarlyAccess:function(){return!1}},conflictingModules:["media-optimizer","dragupload"],modules:[],applications:{Moulinette:i,MoulinetteProgress:k,MoulinetteClient:c,MoulinetteForgeModule:g,MoulinetteFileUtil:n,MoulinetteFilePicker:l,MoulinetteHelp:f,MoulinetteSources:w,MoulinetteAvailableAssets:y,MoulinetteAvailableResult:v,MoulinettePatreon:t,MoulinetteAPI:M},cache:new o,board:{getRandomAsset:S.getRandomAsset},forge:[],macros:[],sources:[{type:"images",publisher:"Foundry VTT",pack:"Core Data Icons",source:"public",path:"icons"}],toggles:{},cloud:{lastSearch:{}}},game.moulinette.toggles.patreon=!0,Handlebars.registerHelper("pretty",(function(e){return isNaN(e)?i.prettyText(e):i.prettyNumber(e)}));const e={moulinette:{layerClass:a,group:"primary"}};CONFIG.Canvas.layers=foundry.utils.mergeObject(Canvas.layers,e)})),Hooks.once("ready",(async function(){if(game.moulinette.modules.push({id:"forge",name:game.i18n.localize("mtte.moulinetteForge"),descr:game.i18n.localize("mtte.moulinetteForgeHelp"),icon:"modules/moulinette-core/img/moulinette.png",class:m}),"undefined"!=typeof ForgeVTT&&ForgeVTT.usingTheForge){const e=await FilePicker.browse("forge-bazaar","assets");for(const t of e.dirs)game.moulinette.sources.push({type:"tiles",publisher:"Bazaar",pack:t.slice(7),source:"forge-bazaar",path:t}),game.moulinette.sources.push({type:"sounds",publisher:"Bazaar",pack:t.slice(7),source:"forge-bazaar",path:t})}game.settings.get("moulinette-core","filepicker")&&(FilePicker=game.moulinette.applications.MoulinetteFilePicker);game.settings.get("moulinette","favorites").constructor!=Object&&game.settings.set("moulinette","favorites",{default:{icon:"fas fa-heart",list:[]}}),SceneNavigation._onLoadProgress||(console.warn("Moulinette Core | SceneNavigation should not be used anymore. Use game.moulinette.applications.MoulinetteProgress."),SceneNavigation._onLoadProgress=function(e,t){SceneNavigation.displayProgressBar({label:e,pct:t})})})),Hooks.once("ready",(async function(){game.user.isGM&&(await n.createFolderRecursive("moulinette"),D.refresh())})),Hooks.on("getSceneControlButtons",(e=>{if(game.user.isGM){const s={activeTool:"select",icon:"fas fa-hammer",layer:"moulinette",name:"moulinette",title:game.i18n.localize("mtte.moulinette"),tools:[{name:"select",icon:"fas fa-expand",title:"Select"}],visible:!0};s.tools.push({name:"patreon",icon:"fab fa-patreon",title:game.i18n.localize("mtte.patreon"),button:!0,onClick:()=>{(new t).render(!0)}}),s.tools.push({name:"refresh",icon:"fas fa-sync",title:game.i18n.localize("mtte.sync"),button:!0,onClick:()=>{game.moulinette.cache.clear(),ui.notifications.info(game.i18n.localize("mtte.refreshed"))}});const i=game.moulinette.forge.sort(((e,t)=>e.name<t.name?-1:1));for(const t of i){s.tools.push({name:t.id,icon:t.icon,title:`${game.i18n.localize("mtte.moulinette")} - ${t.name}`,button:!0,onClick:()=>{const e=game.moulinette.modules.find((e=>"forge"==e.id)).class;new e(t.id).render(!0)}});const i=[];if(t.shortcuts)for(const e of t.shortcuts)i.push({name:e.id,icon:e.icon,title:`${game.i18n.localize("mtte.moulinette")} - ${e.name}`,button:!0,onClick:()=>{t.instance.onShortcut(e.id)}});if(s.tools.push.apply(s.tools,i),t.layer&&game.settings.get("moulinette-core","subControls")){const s=e.find((e=>e.name==t.layer));s&&(s.tools.push({name:t.id,icon:"fas fa-hammer",title:`${game.i18n.localize("mtte.moulinette")} - ${t.name}`,button:!0,onClick:()=>{const e=game.moulinette.modules.find((e=>"forge"==e.id)).class;new e(t.id).render(!0)}}),s.tools.push.apply(s.tools,i))}}s.tools.push({name:"help",icon:"fas fa-question-circle",title:game.i18n.localize("mtte.help"),button:!0,onClick:()=>{(new f).render(!0)}}),e.push(s)}}))})();